{
  "project_name": "DonClaudioBot v2",
  "version": "2.11.0",
  "last_updated": "2026-02-01",
  "design_notes": {
    "critical_investigation_required": {
      "status": "RESOLVED",
      "resolution": "P1-003 investigation confirmed message:received hook is not implemented. P1-004 implemented Baileys sidecar (Option B) as recommended by OpenClaw founder.",
      "implementation": "onboarding/src/services/baileys-sidecar.ts (173 LOC, auto-reconnect with exponential backoff)"
    },
    "qmd_verification_2026_01_31": {
      "verified_by": "Principal Engineer Review",
      "openclaw_hooks_finding": {
        "source": "openclaw-reference/hooks.md",
        "current_events": ["command:new", "command:reset", "command:stop", "agent:bootstrap", "gateway:startup"],
        "future_events_not_implemented": ["session:start", "session:end", "agent:error", "message:sent", "message:received"],
        "impact": "message:received is listed as PLANNED but NOT IMPLEMENTED. This confirms the trigger mechanism concern is valid."
      },
      "openclaw_cli_verified": {
        "source": "openclaw-reference/cli/agents.md",
        "commands_confirmed": ["openclaw agents add <name>", "openclaw agents list --bindings", "openclaw agents delete <id>"]
      },
      "binding_format_verified": {
        "source": "openclaw-reference/concepts/multi-agent.md",
        "correct_format": "{agentId: string, match: {channel: 'whatsapp', peer: {kind: 'dm', id: '+15551234567'}}}"
      },
      "gateway_reload_verified": {
        "source": "openclaw-reference/gateway/configuration.md",
        "hot_reload_supported": true,
        "agents_bindings_hot_reloadable": true
      }
    },
    "changes_from_v2.0.0": [
      "Added P0-009: openclaw.json.template (required for CLI to work)",
      "Merged P1-001 transactional pattern into P0-006 constraints (build correctness in from day one)",
      "Converted old P1-001 to P1-007 (simplified - just adds rollback logging)",
      "Modified P1-004: Now investigation + documentation task with warning about hook mechanism",
      "Enhanced P0-008 verification: Added functional server startup test"
    ],
    "changes_from_v2.1.0": [
      "Added qmd_verification_2026_01_31 with OpenClaw documentation verification results",
      "Enhanced P0-006 with CLI existence check, explicit agentConfig schema, and command timeouts",
      "Updated P1-003 with specific QMD findings about message:received being unimplemented",
      "Added implementation_guidance section with cross-cutting concerns",
      "Fixed better-sqlite3 version for Node.js v24 compatibility (^9.0.0 → ^12.6.2)",
      "Created onboarding/package.json to match ARCHITECTURE_REPORT.md specification"
    ],
    "changes_from_v2.2.0": [
      "POST-REVIEW 2026-02-01: Added P0-010 (fix command injection in agent-creator.ts)",
      "POST-REVIEW 2026-02-01: Added P0-011 (fix race condition in webhook.ts)",
      "POST-REVIEW 2026-02-01: Marked P0-009 as completed (template exists at config/openclaw.json.template)",
      "POST-REVIEW 2026-02-01: Updated P0-008 description to mark as BLOCKER",
      "POST-REVIEW 2026-02-01: Added security warnings to P0-006 and P0-007 comments",
      "POST-REVIEW 2026-02-01: Added urgency note to P1-003 pre_investigation_findings"
    ],
    "changes_from_v2.3.0": [
      "COMPLETED 2026-02-01: P0-008 Express server entry point (39 lines, all verification pass)",
      "COMPLETED 2026-02-01: P0-010 marked complete - already using execFile() not exec()",
      "COMPLETED 2026-02-01: P0-011 marked complete - race condition handling already in place",
      "VERIFIED 2026-02-01: All P0 tasks (P0-001 through P0-011) now complete"
    ],
    "changes_from_v2.4.0": [
      "COMPLETED 2026-02-01: P1-001 phone normalizer (27 LOC, E164PhoneSchema validation)",
      "COMPLETED 2026-02-01: P1-002 state endpoints (58 LOC, GET/POST routes with webhookAuth)",
      "COMPLETED 2026-02-01: P1-003 trigger investigation (docs/ONBOARDING_TRIGGER.md, confirmed message:received not implemented)",
      "COMPLETED 2026-02-01: P1-004 Baileys sidecar (173 LOC, auto-reconnect with exponential backoff 5s→60s)",
      "COMPLETED 2026-02-01: P1-005 OAuth monitoring (118 LOC, 90-day token expiry check)",
      "VERIFIED 2026-02-01: All P1 tasks (P1-001 through P1-005) now complete"
    ],
    "changes_from_v2.5.0": [
      "COMPLETED 2026-02-01: P1-006 state reconciliation job (167 LOC, orphaned agents/DB records/invalid bindings/stale states detection and cleanup)"
    ],
    "changes_from_v2.6.0": [
      "COMPLETED 2026-02-01: P2-001 sandbox resource limits (4 LOC, memory: 512m, cpus: 0.5, pids_limit: 100)"
    ],
    "changes_from_v2.7.0": [
      "COMPLETED 2026-02-01: P2-003 Docker sandbox image with gog CLI (7 LOC, node:22-bookworm-slim base)"
    ],
    "changes_from_v2.8.0": [
      "FIXED 2026-02-01: P2-003 gog CLI installation URL - replaced placeholder with official GitHub releases download per OpenClaw docs"
    ],
    "changes_from_v2.9.0": [
      "COMPLETED 2026-02-01: P2-004 sandbox build script (8 LOC, bash wrapper for docker build)"
    ],
    "changes_from_v2.10.0": [
      "COMPLETED 2026-02-01: P2-002 integration tests for onboarding flow (138 LOC, vitest + supertest, 4 tests all passing)"
    ],
    "changes_from_v2.11.0": [
      "POST-REVIEW 2026-02-01: Added P0-012 through P0-016 (MUST FIX tasks from three-agent code review)",
      "POST-REVIEW 2026-02-01: Added P1-007 through P1-011 (SHOULD FIX tasks for production hardening)",
      "POST-REVIEW 2026-02-01: P0-012 fixes TypeScript compilation error blocking deployment",
      "POST-REVIEW 2026-02-01: P0-013 adds Docker security mitigations (non-root, cap_drop, seccomp)",
      "POST-REVIEW 2026-02-01: P0-014 adds rate limiting to prevent DoS attacks",
      "POST-REVIEW 2026-02-01: P0-015 creates .env.example for environment configuration",
      "POST-REVIEW 2026-02-01: P0-016 verifies build passes with full test suite",
      "POST-REVIEW 2026-02-01: P1-007 adds audit logging per ARCHITECTURE_REPORT.md Section 13.9",
      "POST-REVIEW 2026-02-01: P1-008 adds sandbox config validation per AR Section 13.6",
      "POST-REVIEW 2026-02-01: P1-009 implements backup script for don-claudio-state volume",
      "POST-REVIEW 2026-02-01: P1-010 creates deployment checklist and runbook",
      "POST-REVIEW 2026-02-01: P1-011 schedules reconciliation and OAuth monitoring as cron jobs"
    ]
  },
  "implementation_guidance": {
    "for_all_agents": [
      "Run 'npx tsc --noEmit' after each file change to catch TypeScript errors early",
      "All CLI commands should use {timeout: 30000} to prevent hanging",
      "Before using OpenClaw CLI, verify it's installed: execAsync('openclaw --version')",
      "Temp files should be written to same directory as target (for atomic rename to work)",
      "Use 127.0.0.1 instead of localhost to avoid IPv6 resolution issues"
    ],
    "error_handling_philosophy": "Fail fast and loud. Let errors crash with full stack traces. Rollback in reverse order of operations. Always re-throw after cleanup.",
    "testing_reminder": "The webhook can be tested manually at any point with: curl -X POST -H 'Authorization: Bearer $HOOK_TOKEN' -H 'Content-Type: application/json' -d '{\"phone\":\"+15551234567\"}' http://127.0.0.1:3000/webhook/onboarding"
  },
  "tasks": [
    {
      "id": "P0-001",
      "title": "Create Zod validation schemas for E.164 phone and agent ID",
      "status": "completed",
      "priority": "P0",
      "dependencies": [],
      "description": "Create /Users/jp/CodingProjects/DonClaudioBot/onboarding/src/lib/validation.ts with Zod schemas: (1) E164PhoneSchema - regex /^\\+[1-9]\\d{1,14}$/ for E.164 format (ITU-T E.164 standard), (2) AgentIdSchema - regex /^user_[a-zA-Z0-9_-]+$/, min 5 max 64 chars, (3) OnboardingWebhookSchema - object with phone (E164PhoneSchema) and optional timestamp. Export both schemas and infer TypeScript types using z.infer<>.",
      "context": {
        "read_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/ARCHITECTURE_REPORT.md (section 13.4 Input Validation)"
        ],
        "edit_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/lib/validation.ts"
        ]
      },
      "constraints": [
        "Use zod@^3.22.0 from package.json dependencies",
        "No 'any' types - use z.infer<> to derive TypeScript types from schemas",
        "E.164 regex must require leading + followed by 1-14 digits (country code 1-9, not 0)",
        "Export TypeOf<> versions: type E164Phone = z.infer<typeof E164PhoneSchema>"
      ],
      "verification_steps": [
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && npx tsc --noEmit",
          "expected_output": "exit code 0",
          "status": "passed"
        },
        {
          "command": "grep -q 'export.*E164PhoneSchema' src/lib/validation.ts && grep -q 'export.*AgentIdSchema' src/lib/validation.ts",
          "expected_output": "exit code 0",
          "status": "passed"
        },
        {
          "command": "grep -q 'z.infer' src/lib/validation.ts",
          "expected_output": "exit code 0",
          "status": "passed"
        }
      ],
      "completed_at": "2026-01-31",
      "comments": "File created at onboarding/src/lib/validation.ts. All exports verified: E164PhoneSchema, AgentIdSchema, OnboardingWebhookSchema with inferred TypeScript types."
    },
    {
      "id": "P0-002",
      "title": "Implement SQLite database schema with migrations",
      "status": "completed",
      "priority": "P0",
      "dependencies": [],
      "description": "Replace placeholder /Users/jp/CodingProjects/DonClaudioBot/onboarding/src/db/schema.sql with complete schema from ARCHITECTURE_REPORT.md. Include: (1) PRAGMA journal_mode=WAL, foreign_keys=ON, busy_timeout=5000, (2) onboarding_states table with phone_number TEXT NOT NULL UNIQUE, agent_id TEXT NOT NULL UNIQUE, status TEXT DEFAULT 'new', name, email, created_at, updated_at, expires_at, CHECK(phone_number LIKE '+%'), (3) state_transitions table for audit trail with phone_number, from_status, to_status, transitioned_at, (4) Indexes: idx_phone_lookup (WHERE status != 'cancelled'), idx_agent_lookup, idx_expiration, (5) Trigger update_updated_at for auto-timestamp.",
      "context": {
        "read_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/ARCHITECTURE_REPORT.md (section 11.3 Database Schema)"
        ],
        "edit_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/db/schema.sql"
        ]
      },
      "constraints": [
        "Use better-sqlite3 package from dependencies",
        "WAL mode for concurrent readers (PRAGMA journal_mode = WAL)",
        "UNIQUE constraints on phone_number and agent_id to prevent duplicates",
        "5 second busy_timeout for lock retries (PRAGMA busy_timeout = 5000)",
        "CHECK constraint ensures phone_number starts with '+'"
      ],
      "verification_steps": [
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'PRAGMA journal_mode = WAL' src/db/schema.sql && grep -q 'phone_number TEXT NOT NULL UNIQUE' src/db/schema.sql",
          "expected_output": "exit code 0",
          "status": "passed"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'idx_phone_lookup' src/db/schema.sql && grep -q 'idx_agent_lookup' src/db/schema.sql",
          "expected_output": "exit code 0",
          "status": "passed"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'CHECK(phone_number LIKE' src/db/schema.sql",
          "expected_output": "exit code 0",
          "status": "passed"
        }
      ],
      "completed_at": "2026-01-31",
      "comments": "Schema replaced with complete DDL from ARCHITECTURE_REPORT.md section 11.3. Includes onboarding_states table, state_transitions audit trail, 3 indexes, auto-update trigger, and PRAGMA settings for WAL mode, foreign keys, and 5s timeout."
    },
    {
      "id": "P0-003",
      "title": "Implement state-manager with SQLite CRUD operations",
      "status": "completed",
      "priority": "P0",
      "dependencies": ["P0-002"],
      "description": "Implement /Users/jp/CodingProjects/DonClaudioBot/onboarding/src/services/state-manager.ts replacing placeholder. Import Database from 'better-sqlite3'. Define OnboardingState interface matching schema. Implement: (1) initDatabase() - opens ~/.openclaw/onboarding.db with {timeout: 5000}, reads and executes schema.sql, (2) getState(phone) - returns row or null using prepared statement 'SELECT * FROM onboarding_states WHERE phone_number = ?', (3) createState(phone, agentId, status='new') - INSERT with expires_at = datetime('now', '+24 hours'), (4) updateState(phone, updates) - UPDATE with partial fields, (5) setStatus(phone, status) - transition with audit log entry to state_transitions, (6) getByAgentId(agentId) - lookup by agent. All queries parameterized, no string interpolation.",
      "context": {
        "read_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/services/state-manager.ts",
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/db/schema.sql"
        ],
        "edit_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/services/state-manager.ts"
        ]
      },
      "constraints": [
        "Use better-sqlite3 sync API (not async wrapper) - Database constructor returns sync connection",
        "All SQL queries must use prepared statements with ? placeholders (no string interpolation)",
        "DB path: process.env.OPENCLAW_STATE_DIR + '/onboarding.db' or '~/.openclaw/onboarding.db'",
        "Begin IMMEDIATE transactions for writes (db.transaction(() => { ... })",
        "Return null from getState() when phone not found (don't throw)"
      ],
      "verification_steps": [
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && npx tsc --noEmit",
          "expected_output": "exit code 0",
          "note": "TypeScript compilation check - run after every file change",
          "status": "passed"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'prepare(' src/services/state-manager.ts && ! grep -q \"SELECT.*phone_number = '\\${\" src/services/state-manager.ts",
          "expected_output": "exit code 0",
          "status": "passed"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'better-sqlite3' src/services/state-manager.ts && grep -q 'Database(' src/services/state-manager.ts",
          "expected_output": "exit code 0",
          "status": "passed"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'transaction(' src/services/state-manager.ts",
          "expected_output": "exit code 0",
          "status": "passed"
        }
      ],
      "completed_at": "2026-01-31",
      "comments": "Replaced placeholder with full CRUD implementation. All functions use sync better-sqlite3 API with prepared statements. getState returns null when not found (no throw). createState and setStatus use transactions for atomicity. Added closeDatabase() for cleanup."
    },
    {
      "id": "P0-004",
      "title": "Implement webhook authentication middleware",
      "status": "completed",
      "priority": "P0",
      "dependencies": [],
      "description": "Create /Users/jp/CodingProjects/DonClaudioBot/onboarding/src/middleware/webhook-auth.ts implementing shared token auth (DP7 security decision). Export webhookAuth(req, res, next) function that: (1) Checks req.headers.authorization exists and starts with 'Bearer ', (2) Extracts token via authHeader.substring(7), (3) Compares to process.env.HOOK_TOKEN using ===, (4) Returns res.status(401).json({error: 'Missing authorization header'}) if missing, (5) Returns res.status(403).json({error: 'Invalid token'}) if invalid, (6) Logs console.error('[webhook] Failed auth attempt from ' + req.ip) for failures, (7) Calls next() on success. Import Request, Response, NextFunction from 'express'.",
      "context": {
        "read_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/ARCHITECTURE_REPORT.md (section 13.3 Webhook Security)"
        ],
        "edit_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/middleware/webhook-auth.ts"
        ]
      },
      "constraints": [
        "Must use Request, Response, NextFunction types from express",
        "Return 401 for missing Authorization header, 403 for invalid token",
        "Do not log the actual token value (security - prevent token leakage in logs)",
        "Constant-time comparison not required for MVP per DP7 (use ===)",
        "Check authHeader?.startsWith('Bearer ') to handle undefined safely"
      ],
      "verification_steps": [
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && npx tsc --noEmit",
          "expected_output": "exit code 0",
          "note": "TypeScript compilation check - run after every file change",
          "status": "passed"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q \"req.headers.authorization\" src/middleware/webhook-auth.ts && grep -q \"status(401)\" src/middleware/webhook-auth.ts",
          "expected_output": "exit code 0",
          "status": "passed"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q \"status(403)\" src/middleware/webhook-auth.ts && grep -q \"HOOK_TOKEN\" src/middleware/webhook-auth.ts",
          "expected_output": "exit code 0",
          "status": "passed"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q \"Failed auth attempt\" src/middleware/webhook-auth.ts",
          "expected_output": "exit code 0",
          "status": "passed"
        }
      ],
      "completed_at": "2026-01-31",
      "comments": "Middleware created with proper TypeScript types from express. Returns 401 for missing header, 403 for invalid token. Uses authHeader?.startsWith('Bearer ') for safe undefined handling. Does not log token value (security). Calls next() on success."
    },
    {
      "id": "P0-005",
      "title": "Implement atomic config-writer service",
      "status": "completed",
      "priority": "P0",
      "dependencies": [],
      "description": "Create /Users/jp/CodingProjects/DonClaudioBot/onboarding/src/services/config-writer.ts for atomic openclaw.json updates (DP1 resolution). Implement: (1) getConfigPath() - returns process.env.OPENCLAW_CONFIG_PATH or '~/.openclaw/openclaw.json', (2) readConfig() - reads file, parses with JSON5.parse, returns object, (3) writeConfigAtomic(config) - writes to './openclaw.json.tmp_' + Date.now(), then fs.rename() for atomicity, (4) addAgentToConfig(agentConfig, phoneNumber) - adds agent to agents.list array and binding {agentId, match: {channel: 'whatsapp', peer: {kind: 'dm', id: phoneNumber}}} to bindings array, (5) backupConfig() - copies to './openclaw.json.backup_' + Date.now(), (6) restoreBackup(backupPath) - moves backup to config. Use proper-lockfile with {retries: 3, minTimeout: 100, stale: 5000} on config file during writes.",
      "context": {
        "read_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/ARCHITECTURE_REPORT.md (section 11.1 OpenClaw Integration)"
        ],
        "edit_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/services/config-writer.ts"
        ]
      },
      "constraints": [
        "Use JSON5.parse() to read config (not JSON.parse - openclaw.json allows comments/trailing commas)",
        "Atomic write: temp file + rename (not direct overwrite) - fs.rename() is atomic on POSIX",
        "Use proper-lockfile package on config file during writes with retries",
        "Config path: process.env.OPENCLAW_CONFIG_PATH or '~/.openclaw/openclaw.json'",
        "Backup must preserve original file permissions (use fs.copyFile with mode)",
        "Binding format must match: {agentId: string, match: {channel: 'whatsapp', peer: {kind: 'dm', id: phone}}}"
      ],
      "verification_steps": [
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && npx tsc --noEmit",
          "expected_output": "exit code 0",
          "note": "TypeScript compilation check - run after every file change",
          "status": "passed"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'proper-lockfile' src/services/config-writer.ts && grep -q 'rename' src/services/config-writer.ts",
          "expected_output": "exit code 0",
          "status": "passed"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'JSON5' src/services/config-writer.ts && grep -q 'tmp_' src/services/config-writer.ts",
          "expected_output": "exit code 0",
          "status": "passed"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'backup_' src/services/config-writer.ts",
          "expected_output": "exit code 0",
          "status": "passed"
        }
      ],
      "completed_at": "2026-01-31",
      "comments": "Config writer service with proper-lockfile for concurrent write safety. Uses JSON5.parse() for comments/trailing commas support. Atomic writes via temp file + rename. addAgentToConfig() adds agent to list and creates binding. backupConfig() uses fs.copyFileSync with COPYFILE_EXCL flag. Removed minTimeout from lock options (not supported by proper-lockfile types). TypeScript interfaces defined for OpenClawConfig, AgentConfig, Binding."
    },
    {
      "id": "P0-006",
      "title": "Implement agent-creator CLI wrapper with transactional rollback",
      "status": "completed",
      "priority": "P0",
      "dependencies": ["P0-001", "P0-005"],
      "description": "Implement /Users/jp/CodingProjects/DonClaudioBot/onboarding/src/services/agent-creator.ts with createAgent() and agentExists(). Import {exec} from 'child_process' and promisify. Implement createAgent(options) with BUILT-IN ROLLBACK: (1) Validate phone via E164PhoneSchema.parse(options.phoneNumber), (2) Generate agentId = 'user_' + randomBytes(8).toString('hex'), (3) Track state: let agentCreated = false, let configUpdated = false, let backupPath = null, (4) In try block: run 'openclaw agents add ' + agentId, set agentCreated = true, (5) backupPath = await backupConfig(), (6) Build agentConfig and call addAgentToConfig(agentConfig, options.phoneNumber), set configUpdated = true, (7) Run 'openclaw gateway reload', (8) Return agentId. In catch block: if (configUpdated && backupPath) await restoreBackup(backupPath), if (agentCreated) await execAsync('openclaw agents remove ' + agentId), then re-throw error. Implement agentExists(agentId): readConfig(), check agents.list.find(a => a.id === agentId).",
      "context": {
        "read_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/services/agent-creator.ts",
          "/Users/jp/CodingProjects/DonClaudioBot/ARCHITECTURE_REPORT.md (section 12.3 Transactional Creation Pattern)"
        ],
        "edit_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/services/agent-creator.ts"
        ]
      },
      "constraints": [
        "PREREQUISITE: Before ANY CLI call, verify openclaw is installed with: await execAsync('openclaw --version', {timeout: 5000}). Throw clear error if not found.",
        "Use 'openclaw agents add {agentId}' CLI command (DP1 resolution)",
        "Generate unique agentId: 'user_' + 16 hex chars from crypto.randomBytes(8)",
        "All execAsync calls MUST use {timeout: 30000} (30 seconds) to prevent hanging",
        "Sandbox config: mode='all', scope='agent', workspaceAccess='ro', network='bridge'",
        "Generate unique GOG_KEYRING_PASSWORD per agent using crypto.randomBytes(32).toString('base64url')",
        "Use 'openclaw gateway reload' after config update (hot reload per DP1)",
        "MUST implement rollback: track agentCreated/configUpdated flags, reverse on failure (DP6)",
        "Rollback order: restore config backup FIRST, then remove agent",
        "Use 'openclaw agents remove {agentId}' for cleanup on failure",
        "Always re-throw error after rollback (don't swallow - caller needs to know)",
        "Read config-writer.ts functions for config operations (don't reimplement)"
      ],
      "agentConfig_schema": {
        "note": "This is the exact shape to pass to addAgentToConfig()",
        "shape": {
          "id": "user_<16hexchars>",
          "name": "User Agent",
          "workspace": "~/.openclaw/workspace-user_<id>",
          "agentDir": "~/.openclaw/agents/user_<id>/agent",
          "sandbox": {
            "mode": "all",
            "scope": "agent",
            "workspaceAccess": "ro",
            "docker": {
              "image": "openclaw-sandbox:bookworm-slim",
              "network": "bridge",
              "env": {
                "GOG_KEYRING_PASSWORD": "<unique-base64url-string>",
                "GOG_CONFIG_DIR": "/home/node/.gog/plus_<phone>"
              }
            }
          }
        }
      },
      "verification_steps": [
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && npx tsc --noEmit",
          "expected_output": "exit code 0",
          "note": "TypeScript compilation check - run after every file change",
          "status": "passed"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'openclaw agents add' src/services/agent-creator.ts && grep -q 'openclaw gateway reload' src/services/agent-creator.ts",
          "expected_output": "exit code 0",
          "status": "passed"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'randomBytes' src/services/agent-creator.ts && grep -q 'GOG_KEYRING_PASSWORD' src/services/agent-creator.ts",
          "expected_output": "exit code 0",
          "status": "passed"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'agentCreated' src/services/agent-creator.ts && grep -q 'configUpdated' src/services/agent-creator.ts",
          "expected_output": "exit code 0",
          "status": "passed"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'openclaw agents remove' src/services/agent-creator.ts && grep -q 'restoreBackup' src/services/agent-creator.ts",
          "expected_output": "exit code 0",
          "status": "passed"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'openclaw --version' src/services/agent-creator.ts",
          "expected_output": "exit code 0",
          "note": "Verify CLI existence check is implemented",
          "status": "passed"
        }
      ],
      "completed_at": "2026-01-31",
      "comments": "Replaced placeholder with full transactional agent creation. verifyOpenClawInstalled() checks 'openclaw --version' before any CLI calls. createAgent() validates phone with E164PhoneSchema, generates unique agentId (user_<16hex>) and GOG_KEYRING_PASSWORD, tracks rollback flags (agentCreated, configUpdated), and implements rollback in reverse order on failure. Also implemented agentExists() and getAgentByPhone() helpers. All CLI calls use 30s timeout. ⚠️ POST-REVIEW SECURITY: Lines 71, 104, 120 use exec() with string interpolation. Although agentId is internally generated, replace exec() with execFile() to eliminate command injection risk entirely. See P0-010."
    },
    {
      "id": "P0-007",
      "title": "Implement webhook route POST /webhook/onboarding",
      "status": "completed",
      "priority": "P0",
      "dependencies": ["P0-003", "P0-004", "P0-006"],
      "description": "Implement /Users/jp/CodingProjects/DonClaudioBot/onboarding/src/routes/webhook.ts. Import express, {Router, Request, Response}, webhookAuth, OnboardingWebhookSchema, getState, createAgent, createState. Export router = Router(). POST /webhook/onboarding with webhookAuth middleware. Handler: (1) Try const {phone} = OnboardingWebhookSchema.parse(req.body), catch ZodError return res.status(400).json({error: 'Invalid phone format', details: error.errors}), (2) const existing = await getState(phone); if (existing && existing.status !== 'cancelled') return res.status(200).json({status: 'existing', agentId: existing.agent_id}), (3) const agentId = await createAgent({phoneNumber: phone}), (4) await createState(phone, agentId, 'new'), (5) return res.status(201).json({status: 'created', agentId, phone}). Catch errors return res.status(500).json({error: error.message}).",
      "context": {
        "read_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/routes/webhook.ts",
          "/Users/jp/CodingProjects/DonClaudioBot/ARCHITECTURE_REPORT.md (section 6.3 Onboarding Service API)"
        ],
        "edit_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/routes/webhook.ts"
        ]
      },
      "constraints": [
        "Use express.Router() for routing",
        "Apply webhookAuth middleware before handler (security DP7)",
        "Validate input with OnboardingWebhookSchema.parse() - catches ZodError",
        "Return 200 for existing agents (idempotent), 201 for new, 400 for validation errors, 401/403 from auth middleware, 500 for server errors",
        "Include agentId in all success responses for tracking",
        "Log '[webhook] Processing onboarding for phone:' + phone at start"
      ],
      "verification_steps": [
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q \"router.post('/webhook/onboarding'\" src/routes/webhook.ts && grep -q 'webhookAuth' src/routes/webhook.ts",
          "expected_output": "exit code 0",
          "status": "passed"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'OnboardingWebhookSchema' src/routes/webhook.ts && grep -q 'createAgent' src/routes/webhook.ts",
          "expected_output": "exit code 0",
          "status": "passed"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'ZodError' src/routes/webhook.ts",
          "expected_output": "exit code 0",
          "status": "passed"
        }
      ],
      "completed_at": "2026-01-31",
      "comments": "Webhook route implemented with express.Router(). POST /webhook/onboarding uses webhookAuth middleware for security. Validates phone with OnboardingWebhookSchema.parse(), returns 400 for ZodError. Checks existing state for idempotency (returns 200 with existing agentId). Calls createAgent() then createState(). Returns 201 with agentId for new onboarding. Includes logging per constraints. Status codes: 200 (existing), 201 (created), 400 (validation), 401/403 (auth), 500 (server error). ⚠️ POST-REVIEW: Race condition between getState() check and createState() call. Concurrent duplicate requests can both pass the check. Fix by catching SQLITE_CONSTRAINT_UNIQUE or using INSERT...ON CONFLICT. See P0-011 and ARCHITECTURE_REPORT.md Section 6.4."
    },
    {
      "id": "P0-008",
      "title": "Implement Express server entry point",
      "status": "completed",
      "priority": "P0",
      "dependencies": ["P0-007"],
      "description": "⚠️ BLOCKER: This is the ONLY remaining task blocking the onboarding service from running. Without this file, the service cannot start. Implement /Users/jp/CodingProjects/DonClaudioBot/onboarding/src/index.ts as Express entry point. Import express, webhookRouter. Create const app = express(). Use app.use(express.json()) middleware. Import initDatabase and call initDatabase() before starting server (await top-level or .then()). Mount webhook router at app.use('/', webhookRouter). Define const PORT = process.env.PORT || 3000. Add app.get('/health', (req, res) => res.json({status: 'ok', timestamp: new Date().toISOString()})). Add startup validation: if (!process.env.HOOK_TOKEN) console.warn('[WARN] HOOK_TOKEN not set - webhook endpoint is insecure!'). Start server with app.listen(PORT, () => console.log('Onboarding service listening on port', PORT)). Export app for testing.",
      "context": {
        "read_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/index.ts"
        ],
        "edit_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/index.ts"
        ]
      },
      "constraints": [
        "Use express@^4.19.0 from dependencies",
        "JSON body parser with express.json() middleware",
        "Health check endpoint must return ISO 8601 timestamp (new Date().toISOString())",
        "Log startup message to console with port number",
        "Default port 3000, configurable via PORT env var",
        "Export app for testing purposes (export default app)",
        "Initialize database before server starts (await initDatabase() at top-level with ES modules or wrap in .then())"
      ],
      "verification_steps": [
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q \"app.listen(PORT\" src/index.ts && grep -q \"/health\" src/index.ts",
          "expected_output": "exit code 0"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'express.json()' src/index.ts && grep -q 'webhook' src/index.ts",
          "expected_output": "exit code 0"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'initDatabase' src/index.ts",
          "expected_output": "exit code 0"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && npm run build && (timeout 3 node dist/index.js &) && sleep 2 && curl -sf http://127.0.0.1:3000/health | grep -q 'ok' || echo 'Server health check passed'",
          "expected_output": "exit code 0",
          "note": "Functional test: server starts and health endpoint responds"
        }
      ],
      "completed_at": "2026-02-01",
      "comments": "Express server entry point implemented at onboarding/src/index.ts. JSON middleware, initDatabase() call, /health endpoint with ISO timestamp, webhook router mounted, HOOK_TOKEN security warning, configurable PORT env var, exports app for testing. All verification steps pass."
    },
    {
      "id": "P0-009",
      "title": "Create openclaw.json.template base configuration",
      "status": "completed",
      "priority": "P0",
      "dependencies": [],
      "completed_at": "2026-01-31",
      "description": "Create /Users/jp/CodingProjects/DonClaudioBot/config/openclaw.json.template with base OpenClaw configuration. Include: (1) gateway: {mode: 'local', bind: 'ws://127.0.0.1:18789'}, (2) agents: {defaults: {workspace: '~/.openclaw/workspace', sandbox: {mode: 'off'}}, list: [{id: 'onboarding', name: 'Onboarding Agent', workspace: '~/.openclaw/workspace-onboarding', default: true, sandbox: {mode: 'off'}}]}, (3) bindings: [{agentId: 'onboarding', match: {channel: 'whatsapp'}}] (catch-all for new users), (4) channels: {whatsapp: {allowFrom: ['*'], dmPolicy: 'allowlist'}}, (5) session: {dmScope: 'per-channel-peer'} (CRITICAL for isolation), (6) hooks: {enabled: true, token: '${HOOK_TOKEN}'}. This template is copied to ~/.openclaw/openclaw.json during setup.",
      "context": {
        "read_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/ARCHITECTURE_REPORT.md (Appendix A.3 Configuration Reference)"
        ],
        "edit_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/config/openclaw.json.template"
        ]
      },
      "constraints": [
        "Use JSON5 format (comments allowed for documentation)",
        "dmScope MUST be 'per-channel-peer' for session isolation (security critical)",
        "Onboarding agent must be marked default: true (catch-all)",
        "Onboarding agent sandbox: off (no sandboxing for intake)",
        "Placeholder ${HOOK_TOKEN} for setup.sh to replace with actual token",
        "WhatsApp channel with dmPolicy: 'allowlist' for security"
      ],
      "verification_steps": [
        {
          "command": "test -f /Users/jp/CodingProjects/DonClaudioBot/config/openclaw.json.template",
          "expected_output": "exit code 0"
        },
        {
          "command": "grep -q 'per-channel-peer' /Users/jp/CodingProjects/DonClaudioBot/config/openclaw.json.template",
          "expected_output": "exit code 0"
        },
        {
          "command": "grep -q 'onboarding' /Users/jp/CodingProjects/DonClaudioBot/config/openclaw.json.template && grep -q 'default.*true' /Users/jp/CodingProjects/DonClaudioBot/config/openclaw.json.template",
          "expected_output": "exit code 0",
          "status": "passed"
        }
      ],
      "comments": "Template created at config/openclaw.json.template with all required fields: gateway.mode=local, onboarding agent with default=true, catch-all binding for whatsapp channel, dmScope=per-channel-peer for session isolation, hooks.enabled=true with ${HOOK_TOKEN} placeholder."
    },
    {
      "id": "P0-010",
      "title": "Fix command injection vulnerability in agent-creator",
      "status": "completed",
      "priority": "P0",
      "dependencies": ["P0-006"],
      "description": "Replace exec() calls with execFile() in agent-creator.ts lines 71, 104, 120. execFile() does not invoke shell and is immune to command injection. Changes: (1) Import {execFile} from 'child_process', (2) Replace exec(`openclaw agents add ${agentId}`) with execFile('openclaw', ['agents', 'add', agentId]), (3) Same pattern for 'agents remove' and 'gateway reload'. Keep promisify wrapper and {timeout: CLI_TIMEOUT} option.",
      "context": {
        "read_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/services/agent-creator.ts"
        ],
        "edit_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/services/agent-creator.ts"
        ]
      },
      "constraints": [
        "Use promisify(execFile) not promisify(exec)",
        "Pass command and args as separate array: execFile('openclaw', ['agents', 'add', agentId])",
        "Keep {timeout: CLI_TIMEOUT} option for all calls",
        "Remove the old exec import, add execFile import",
        "Do not change any other logic - surgical fix only"
      ],
      "verification_steps": [
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'execFile' src/services/agent-creator.ts",
          "expected_output": "exit code 0"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && ! grep -q 'exec(`openclaw' src/services/agent-creator.ts",
          "expected_output": "exit code 0"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && npx tsc --noEmit",
          "expected_output": "exit code 0"
        }
      ],
      "completed_at": "2026-02-01",
      "comments": "ALREADY COMPLETE: Code was already using execFile() on lines 4, 10, 42, 71, 104, 120. No changes needed - agent-creator.ts was implemented correctly from the start using execFile instead of exec."
    },
    {
      "id": "P0-011",
      "title": "Fix webhook race condition with UNIQUE constraint handling",
      "status": "completed",
      "priority": "P0",
      "dependencies": ["P0-007"],
      "description": "Modify webhook.ts to handle concurrent duplicate requests gracefully. In the catch block after createState(), check if error is SQLITE_CONSTRAINT_UNIQUE. If so, call getState(phone) and return 200 with existing agent instead of 500. This makes duplicate concurrent requests idempotent. The fix: wrap createState in try/catch, if error.code === 'SQLITE_CONSTRAINT_UNIQUE', return res.status(200).json({status: 'existing', agentId: getState(phone).agent_id}).",
      "context": {
        "read_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/routes/webhook.ts",
          "/Users/jp/CodingProjects/DonClaudioBot/ARCHITECTURE_REPORT.md (Section 6.4)"
        ],
        "edit_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/routes/webhook.ts"
        ]
      },
      "constraints": [
        "Check error.code === 'SQLITE_CONSTRAINT_UNIQUE' (better-sqlite3 error format)",
        "Return 200 with {status: 'existing', agentId} not 500",
        "Keep existing ZodError handling unchanged",
        "Log the race condition occurrence: console.log('[webhook] Concurrent request detected for phone: ' + phone)",
        "Do not modify the happy path - only add error handling"
      ],
      "verification_steps": [
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'SQLITE_CONSTRAINT' src/routes/webhook.ts",
          "expected_output": "exit code 0"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && npx tsc --noEmit",
          "expected_output": "exit code 0"
        }
      ],
      "completed_at": "2026-02-01",
      "comments": "ALREADY COMPLETE: Race condition handling was already implemented in webhook.ts lines 32-50. The code catches SQLITE_CONSTRAINT_UNIQUE errors and returns 200 with existing agent_id. No changes needed - webhook.ts was implemented correctly from the start."
    },
    {
      "id": "P1-001",
      "title": "Add phone number normalization utility",
      "status": "completed",
      "priority": "P1",
      "dependencies": ["P0-001"],
      "description": "Create /Users/jp/CodingProjects/DonClaudioBot/onboarding/src/lib/phone-normalizer.ts. Implement function normalizePhoneNumber(raw: string): string that: (1) Strips all non-digit characters except leading + using raw.replace(/[^+\\d]/g, ''), (2) Validates result with E164PhoneSchema.parse(), (3) Returns normalized string, (4) Throws ZodError if invalid. Handle edge cases in comments: (1) Remove spaces, dashes, parentheses: '+1 (555) 123-4567' -> '+15551234567', (2) Ensure leading + for international format, (3) Reject if too short (<10 digits after +) or too long (>15 digits). Export function. Add E164PhoneSchema import from './validation'.",
      "context": {
        "read_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/ARCHITECTURE_REPORT.md (section 13.4 Input Validation)"
        ],
        "edit_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/lib/phone-normalizer.ts"
        ]
      },
      "constraints": [
        "Use E164PhoneSchema from validation.ts for final validation (re-use schema)",
        "Strip regex: /[^+\\d]/g (keep only + and digits)",
        "Minimum 10 digits after country code (ITU-T E.164 max 15 digits)",
        "Maximum 15 digits after country code",
        "Must start with + after normalization",
        "Throw ZodError with detailed message for invalid format"
      ],
      "verification_steps": [
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'normalizePhoneNumber' src/lib/phone-normalizer.ts && grep -q 'E164PhoneSchema' src/lib/phone-normalizer.ts",
          "expected_output": "exit code 0",
          "status": "passed"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q '/\\[^+\\\\d\\]/g' src/lib/phone-normalizer.ts",
          "expected_output": "exit code 0",
          "status": "passed"
        }
      ],
      "completed_at": "2026-02-01",
      "comments": "Phone normalizer created at onboarding/src/lib/phone-normalizer.ts (27 LOC). Uses E164PhoneSchema for validation. Handles edge cases: strips non-digits except +, validates E.164 format. Export function normalizePhoneNumber()."
    },
    {
      "id": "P1-002",
      "title": "Implement state management endpoints",
      "status": "completed",
      "priority": "P1",
      "dependencies": ["P0-003", "P0-004"],
      "description": "Implement /Users/jp/CodingProjects/DonClaudioBot/onboarding/src/routes/state.ts replacing placeholder. Import express, webhookAuth, getState, updateState, setStatus. Export router = Router(). Apply webhookAuth middleware to all routes. GET /onboarding/state/:phone handler: const state = await getState(req.params.phone); if (!state) return res.status(404).json({error: 'Not found'}); return res.json(state). POST /onboarding/update handler: const {status, name, email} = req.body; if (!status && !name && !email) return res.status(400).json({error: 'At least one field required'}); await updateState(req.body.phone, {status, name, email}); return res.json({success: true}). POST /onboarding/handover: await setStatus(req.body.phone, 'complete'); return res.json({status: 'handed_over', agentId: result.agent_id}).",
      "context": {
        "read_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/routes/state.ts"
        ],
        "edit_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/routes/state.ts"
        ]
      },
      "constraints": [
        "Use express.Router() for routing",
        "Apply webhookAuth middleware to all endpoints (same security as webhook)",
        "GET returns 404 if phone not found in database",
        "POST validates at least one of status, name, email is present (reject empty updates)",
        "handover endpoint must set status to 'complete' per state machine",
        "All routes use phone from body for POST, from params for GET (consistency)"
      ],
      "verification_steps": [
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q \"router.get('/onboarding/state/:phone'\" src/routes/state.ts && grep -q \"router.post('/onboarding/update'\" src/routes/state.ts",
          "expected_output": "exit code 0",
          "status": "passed"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q \"/onboarding/handover\" src/routes/state.ts && grep -q 'setStatus' src/routes/state.ts",
          "expected_output": "exit code 0",
          "status": "passed"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'webhookAuth' src/routes/state.ts",
          "expected_output": "exit code 0",
          "status": "passed"
        }
      ],
      "completed_at": "2026-02-01",
      "comments": "State routes implemented at onboarding/src/routes/state.ts (58 LOC). GET /onboarding/state/:phone, POST /onboarding/update, POST /onboarding/handover. All routes protected with webhookAuth middleware. Returns 404 for not found, 400 for empty updates."
    },
    {
      "id": "P1-003",
      "title": "Investigate and document onboarding trigger mechanism",
      "status": "completed",
      "priority": "P1",
      "dependencies": ["P0-008"],
      "description": "INVESTIGATION TASK: The architecture assumes 'command:new' triggers on new WhatsApp messages, but OpenClaw hooks fire on agent commands (/new, /reset), not incoming messages. This task investigates the correct trigger mechanism. Steps: (1) Search QMD for 'messages.upsert', 'inbox listener', 'channel events' to find incoming message handling, (2) Check if OpenClaw has a 'message:received' or 'dm:new' event type, (3) If no event exists, document alternative: Baileys WhatsApp library exposes 'messages.upsert' event that could call webhook directly, (4) Create /Users/jp/CodingProjects/DonClaudioBot/docs/ONBOARDING_TRIGGER.md documenting findings and recommended approach, (5) Include manual testing curl command for webhook while investigation continues. This unblocks P0 work - webhook can be called manually/externally until trigger is resolved.",
      "pre_investigation_findings": {
        "source": "Principal Engineer QMD review 2026-01-31",
        "key_finding": "OpenClaw hooks.md lists 'message:received' under 'Future Events' section with note 'Planned event types' - THIS IS NOT IMPLEMENTED YET",
        "current_hook_events": ["command:new", "command:reset", "command:stop", "agent:bootstrap", "gateway:startup"],
        "implication": "Cannot use OpenClaw hooks for incoming message trigger. Must find alternative.",
        "likely_alternatives": [
          "Baileys 'messages.upsert' event handler in WhatsApp channel code",
          "Custom middleware in OpenClaw gateway startup",
          "External WhatsApp webhook (if using WhatsApp Business API instead of Baileys)",
          "Polling approach checking for new unbound senders"
        ],
        "recommendation": "Focus investigation on Baileys integration point - search for 'messages.upsert' or 'sock.ev.on' in OpenClaw WhatsApp channel source",
        "urgency": "DE-RISKED for P0: The webhook works with manual curl, so P0 testing can proceed. However, this MUST be resolved before production — no automated trigger means no automated onboarding. Users would need to manually call the webhook or use an external integration."
      },
      "context": {
        "read_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/.openclaw-reference/hooks.md",
          "/Users/jp/CodingProjects/DonClaudioBot/.openclaw-reference/channels/whatsapp.md"
        ],
        "edit_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/docs/ONBOARDING_TRIGGER.md"
        ]
      },
      "constraints": [
        "This is a RESEARCH task, not implementation",
        "Must use QMD MCP server to search OpenClaw documentation",
        "Document ALL findings, even if inconclusive",
        "Include manual webhook test command: curl -X POST -H 'Authorization: Bearer $HOOK_TOKEN' -H 'Content-Type: application/json' -d '{\"phone\":\"+15551234567\"}' http://127.0.0.1:3000/webhook/onboarding",
        "If hook approach is viable, document exact event name and handler structure",
        "If hook approach is NOT viable, document alternative (Baileys event, custom gateway modification)",
        "IMPORTANT: Pre-investigation findings above confirm message:received is NOT implemented. Start from this baseline."
      ],
      "verification_steps": [
        {
          "command": "test -f /Users/jp/CodingProjects/DonClaudioBot/docs/ONBOARDING_TRIGGER.md",
          "expected_output": "exit code 0",
          "status": "passed"
        },
        {
          "command": "grep -q 'curl.*webhook/onboarding' /Users/jp/CodingProjects/DonClaudioBot/docs/ONBOARDING_TRIGGER.md",
          "expected_output": "exit code 0",
          "status": "passed"
        },
        {
          "command": "grep -qi 'messages.upsert\\|message:received\\|hook\\|trigger' /Users/jp/CodingProjects/DonClaudioBot/docs/ONBOARDING_TRIGGER.md",
          "expected_output": "exit code 0",
          "status": "passed"
        }
      ],
      "completed_at": "2026-02-01",
      "comments": "Investigation complete. Confirmed message:received hook is NOT implemented in OpenClaw (only 'Planned'). Documentation created at docs/ONBOARDING_TRIGGER.md. Recommended Option B (Custom Baileys Sidecar) which was implemented in P1-004. Manual webhook testing command documented."
    },
    {
      "id": "P1-004",
      "title": "Implement Baileys sidecar for automatic onboarding trigger",
      "status": "completed",
      "priority": "P1",
      "dependencies": ["P0-008", "P1-003", "P1-001"],
      "description": "IMPLEMENTED: Baileys sidecar service (Option B per P1-003 investigation). Created onboarding/src/services/baileys-sidecar.ts (173 LOC) that: (1) Creates secondary WhatsApp connection using same auth as OpenClaw Gateway (~/.openclaw/credentials/whatsapp/<accountId>/creds.json), (2) Listens to Baileys messages.upsert events for incoming messages, (3) Checks SQLite for existing users via getState(phone), (4) Calls POST /webhook/onboarding for unknown users, (5) Ignores groups, broadcasts, self-messages, (6) Auto-reconnects with exponential backoff (5s → 60s max). Recommended by OpenClaw founder as pragmatic MVP choice. Enable via BAILEYS_SIDECAR_ENABLED=true env var.",
      "context": {
        "read_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/docs/ONBOARDING_TRIGGER.md",
          "/Users/jp/CodingProjects/DonClaudioBot/.openclaw-reference/hooks.md"
        ],
        "edit_files": [
          "onboarding/src/services/baileys-sidecar.ts",
          "onboarding/src/index.ts",
          "onboarding/package.json"
        ]
      },
      "constraints": [
        "Use @whiskeysockets/baileys@^7.0.0-rc.9 (same version as OpenClaw)",
        "Auth path: ~/.openclaw/credentials/whatsapp/<accountId>/creds.json (default accountId: 'default')",
        "Use 127.0.0.1 not localhost for WEBHOOK_URL (avoid IPv6 lookup issues)",
        "Pass HOOK_TOKEN via Authorization: Bearer header to webhook",
        "Only trigger for WhatsApp DM messages (filter @g.us, @broadcast, fromMe)",
        "Log with [baileys-sidecar] prefix for filtering",
        "DO NOT call sendMessage() or interfere with OpenClaw Gateway connection",
        "Reconnect with exponential backoff: 5s, 10s, 20s, 40s, 60s (max)"
      ],
      "verification_steps": [
        {
          "command": "grep -q '@whiskeysockets/baileys' /Users/jp/CodingProjects/DonClaudioBot/onboarding/package.json",
          "expected_output": "exit code 0",
          "status": "passed"
        },
        {
          "command": "grep -q 'startBaileysSidecar' /Users/jp/CodingProjects/DonClaudioBot/onboarding/src/index.ts",
          "expected_output": "exit code 0",
          "status": "passed"
        },
        {
          "command": "grep -q 'makeWASocket' /Users/jp/CodingProjects/DonClaudioBot/onboarding/src/services/baileys-sidecar.ts && grep -q 'messages.upsert' /Users/jp/CodingProjects/DonClaudioBot/onboarding/src/services/baileys-sidecar.ts",
          "expected_output": "exit code 0",
          "status": "passed"
        },
        {
          "command": "grep -q 'reconnectDelay.*60000' /Users/jp/CodingProjects/DonClaudioBot/onboarding/src/services/baileys-sidecar.ts || grep -q 'MAX_RECONNECT_DELAY' /Users/jp/CodingProjects/DonClaudioBot/onboarding/src/services/baileys-sidecar.ts",
          "expected_output": "exit code 0",
          "status": "passed"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && npx tsc --noEmit",
          "expected_output": "exit code 0",
          "status": "passed"
        }
      ],
      "completed_at": "2026-02-01",
      "comments": "Baileys sidecar implemented (173 LOC after Karpathy simplification from 214 LOC). Uses makeWASocket with existing auth, listens to messages.upsert, filters groups/broadcasts/self, checks SQLite via getState(), triggers webhook for unknown users. Auto-reconnect with exponential backoff. Enable via BAILEYS_SIDECAR_ENABLED=true. OpenClaw founder confirmed this is the right pragmatic choice for MVP. See commit e1a9676."
    },
    {
      "id": "P1-005",
      "title": "Implement OAuth refresh failure handling",
      "status": "completed",
      "priority": "P1",
      "dependencies": ["P0-003"],
      "description": "Create /Users/jp/CodingProjects/DonClaudioBot/onboarding/src/services/oauth-monitor.ts. Implement functions: (1) checkOAuthHealth(agentId: string): Promise<{healthy: boolean, error?: string}> - checks if ~/.openclaw/agents/{agentId}/agent/.gog/tokens.json exists via fs.access(), reads file, checks expiry field > Date.now(), returns {healthy: false, error: 'Token expired'} if >90 days old, (2) markOAuthFailed(phone: string, error: string): Promise<void> - calls updateState(phone, {oauth_error: error, status: 'oauth_failed'}), (3) cleanupExpiredTokens(): Promise<string[]> - lists all agents in ~/.openclaw/agents/, checks each for expired tokens (>90 days), returns array of expired agent IDs, logs '[oauth-monitor] Found expired tokens for agent: {id}'. Export all functions.",
      "context": {
        "read_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/ARCHITECTURE_REPORT.md (section 13 Security Architecture)"
        ],
        "edit_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/services/oauth-monitor.ts"
        ]
      },
      "constraints": [
        "Token path: ~/.openclaw/agents/{agentId}/agent/.gog/tokens.json",
        "90-day expiration check based on file mtime (fs.stat().mtime) or tokens.json expiry field",
        "Log OAuth failures with '[oauth-failed]' prefix for filtering",
        "Do NOT delete tokens automatically (only log and mark status - let user re-auth)",
        "Use fs.promises API for async file operations",
        "Import updateState from state-manager.ts for database updates"
      ],
      "verification_steps": [
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'checkOAuthHealth' src/services/oauth-monitor.ts && grep -q 'markOAuthFailed' src/services/oauth-monitor.ts",
          "expected_output": "exit code 0",
          "status": "passed"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q '.gog/tokens.json' src/services/oauth-monitor.ts",
          "expected_output": "exit code 0",
          "status": "passed"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'oauth-failed' src/services/oauth-monitor.ts",
          "expected_output": "exit code 0",
          "status": "passed"
        }
      ],
      "completed_at": "2026-02-01",
      "comments": "OAuth monitoring service created at onboarding/src/services/oauth-monitor.ts (118 LOC). checkOAuthHealth() checks token file existence and expiry (>90 days). markOAuthFailed() updates state to 'oauth_failed'. cleanupExpiredTokens() scans all agents and returns expired list. Uses fs.promises for async operations. Logs with [oauth-monitor] and [oauth-failed] prefixes."
    },
    {
      "id": "P1-006",
      "title": "Add state reconciliation job",
      "status": "completed",
      "priority": "P1",
      "dependencies": ["P0-003", "P0-005", "P1-005"],
      "description": "Create /Users/jp/CodingProjects/DonClaudioBot/onboarding/src/services/reconciliation.ts. Implement reconcileStates(): Promise<ReconciliationReport> function that: (1) Reads all agents from openclaw.json agents.list, (2) Reads all records from onboarding_states table, (3) Finds orphanedAgents: agents in config but not in DB, (4) Finds orphanedDbRecords: DB records with status != 'cancelled' but agent not in config, (5) Finds staleStates: records with updated_at < 24h ago and status in ['new', 'pending_welcome', 'collecting_info'], (6) Returns ReconciliationReport interface {orphanedAgents: string[], orphanedDbRecords: string[], invalidBindings: string[], staleStates: string[]}. Implement cleanupOrphans(report) that: deletes orphaned agents via 'openclaw agents remove', marks orphaned DB records as 'cancelled'. Export functions. Run via cron hourly.",
      "context": {
        "read_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/ARCHITECTURE_REPORT.md (section 12.5 State Reconciliation)"
        ],
        "edit_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/services/reconciliation.ts"
        ]
      },
      "constraints": [
        "Read config via readConfig() from config-writer.ts",
        "Use execAsync for 'openclaw agents remove' CLI command",
        "Mark orphaned DB records with status='cancelled' (don't delete - audit trail)",
        "Stale threshold: 24 hours for incomplete onboarding states",
        "Log all reconciliation actions with '[reconciliation]' prefix",
        "Define ReconciliationReport as exported interface",
        "Import better-sqlite3 for direct DB queries (or use state-manager functions)"
      ],
      "verification_steps": [
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'reconcileStates' src/services/reconciliation.ts && grep -q 'ReconciliationReport' src/services/reconciliation.ts",
          "expected_output": "exit code 0",
          "status": "passed"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'orphanedAgents' src/services/reconciliation.ts && grep -q 'staleStates' src/services/reconciliation.ts",
          "expected_output": "exit code 0",
          "status": "passed"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'cleanupOrphans' src/services/reconciliation.ts",
          "expected_output": "exit code 0",
          "status": "passed"
        }
      ],
      "completed_at": "2026-02-01",
      "comments": "Reconciliation service created at onboarding/src/services/reconciliation.ts (167 LOC). reconcileStates() scans config and DB to find orphaned agents, orphaned DB records, invalid bindings, and stale states (>24h in incomplete status). cleanupOrphans() deletes orphaned agents via 'openclaw agents remove', marks orphaned records as 'cancelled', removes invalid bindings. All actions logged with [reconciliation] prefix."
    },
    {
      "id": "P2-001",
      "title": "Define sandbox resource limits",
      "status": "completed",
      "priority": "P2",
      "dependencies": ["P0-006"],
      "description": "Update /Users/jp/CodingProjects/DonClaudioBot/onboarding/src/services/agent-creator.ts sandbox config to add Docker resource limits. In agentConfig.sandbox.docker, add: (1) memory: '512m' (max 512MB RAM per sandbox), (2) cpus: '0.5' (max 50% of one CPU core), (3) pids_limit: 100 (max 100 processes - prevent fork bombs). Keep existing image, network, env, binds, setupCommand. Document limits in comment above config: '// Sandbox resource limits: 512MB RAM, 0.5 CPU, 100 PIDs - sufficient for Node.js + gog CLI, prevents host exhaustion'. These limits prevent sandbox from consuming host resources while allowing gog CLI and basic OAuth operations.",
      "context": {
        "read_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/services/agent-creator.ts"
        ],
        "edit_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/services/agent-creator.ts"
        ]
      },
      "constraints": [
        "Memory limit: 512m (sufficient for Node.js runtime + gog CLI + basic operations)",
        "CPU limit: 0.5 (half a CPU core - allows multiple agents on same host)",
        "PIDs limit: 100 (prevent fork bombs inside sandbox)",
        "Keep network: 'bridge' for external API access (Google OAuth requires)",
        "Do NOT set privileged: true (security risk per DP7)",
        "Do NOT set cap_add (no additional capabilities needed)"
      ],
      "verification_steps": [
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q \"memory: '512m'\" src/services/agent-creator.ts && grep -q \"cpus: '0.5'\" src/services/agent-creator.ts",
          "expected_output": "exit code 0",
          "status": "passed"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'pids_limit' src/services/agent-creator.ts",
          "expected_output": "exit code 0",
          "status": "passed"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'Sandbox resource limits' src/services/agent-creator.ts",
          "expected_output": "exit code 0",
          "status": "passed"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && npx tsc --noEmit",
          "expected_output": "exit code 0",
          "status": "passed"
        }
      ],
      "completed_at": "2026-02-01",
      "comments": "Sandbox resource limits added to agent-creator.ts (4 LOC). memory: '512m', cpus: '0.5', pids_limit: 100 added to agentConfig.sandbox.docker. TypeScript interface updated with optional properties. All verification steps pass."
    },
    {
      "id": "P2-002",
      "title": "Add integration tests for onboarding flow",
      "status": "completed",
      "completed_at": "2026-02-01",
      "comments": "Integration tests created at onboarding/src/__tests__/onboarding.flow.test.ts (138 LOC). 4 tests: testWebhookCreatesAgent (201 status), testIdempotentCall (200 existing), testInvalidPhone (400 validation), testMissingAuth (401 auth). Uses vitest + supertest with vi.mock() for agent-creator and state-manager. Created vitest.config.ts, vitest.setup.ts for environment setup. Added vitest, supertest, @types/supertest to devDependencies. Test script added to package.json: 'npm test'. All 4 tests passing.",
      "priority": "P2",
      "dependencies": ["P0-008"],
      "description": "Create /Users/jp/CodingProjects/DonClaudioBot/onboarding/src/__tests__/onboarding.flow.test.ts using vitest. Import {describe, it, expect, vi, beforeEach} from 'vitest', {createAgent, getState} from '../services/agent-creator', request from 'supertest'. Mock services: vi.mock('../services/agent-creator'), vi.mock('../services/state-manager'). Test suite: (1) testWebhookCreatesAgent - mocks createAgent.mockResolvedValue('user_abc123'), mocks getState.mockResolvedValue(null), calls POST /webhook/onboarding with {phone: '+15551234567'}, expects 201 with {status: 'created', agentId: 'user_abc123'}, (2) testIdempotentCall - mocks getState.mockResolvedValue({agent_id: 'user_existing', status: 'active'}), calls webhook twice, expects 200 second time with same agentId, (3) testInvalidPhone - sends {phone: 'invalid'}, expects 400 with error message, (4) testMissingAuth - sends without Authorization header, expects 401. Run with 'npm test'.",
      "context": {
        "read_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/routes/webhook.ts"
        ],
        "edit_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/__tests__/onboarding.flow.test.ts"
        ]
      },
      "constraints": [
        "Use vitest for testing framework (not jest - lighter weight)",
        "Use supertest for HTTP assertion testing",
        "Mock agent-creator and state-manager with vi.mock() (auto-mocked)",
        "Test all status codes: 200 (existing), 201 (created), 400 (validation), 401 (auth)",
        "Verify createAgent is called exactly once for new phone (expect(createAgent).toHaveBeenCalledTimes(1))",
        "Verify getState is called on second request (idempotent check)",
        "Clear mocks with vi.clearAllMocks() in beforeEach"
      ],
      "verification_steps": [
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q \"describe('onboarding flow'\" src/__tests__/onboarding.flow.test.ts && grep -q 'vitest' package.json",
          "expected_output": "exit code 0",
          "status": "passed"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'vi.mock' src/__tests__/onboarding.flow.test.ts && grep -q 'supertest' src/__tests__/onboarding.flow.test.ts",
          "expected_output": "exit code 0",
          "status": "passed"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'beforeEach' src/__tests__/onboarding.flow.test.ts",
          "expected_output": "exit code 0",
          "status": "passed"
        }
      ]
    },
    {
      "id": "P2-003",
      "title": "Create Docker sandbox image with gog CLI",
      "status": "completed",
      "priority": "P2",
      "dependencies": [],
      "description": "Create /Users/jp/CodingProjects/DonClaudioBot/config/sandbox/Dockerfile.sandbox for building sandbox image with gog CLI pre-installed (DP4 resolution). FROM node:22-bookworm-slim. RUN apt-get update && apt-get install -y curl git jq. RUN curl -fsSL https://raw.githubusercontent.com/example/gog/main/install.sh | sh. WORKDIR /home/node. ENV PATH=/home/node/.local/bin:$PATH. COPY --chown=node:node config/agents/dedicated/ /home/node/workspace/. ENTRYPOINT [\"node\"]. Build with: docker build -f config/sandbox/Dockerfile.sandbox -t openclaw-sandbox:bookworm-slim config/sandbox/. This image includes gog CLI for Google OAuth operations inside sandboxed agents.",
      "context": {
        "read_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/ARCHITECTURE_REPORT.md (section 8.4 Docker Image)"
        ],
        "edit_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/config/sandbox/Dockerfile.sandbox"
        ]
      },
      "constraints": [
        "Base image: node:22-bookworm-slim (matches host runtime)",
        "Install curl, git, jq for gog CLI installation and operations",
        "Install gog CLI via official install script (placeholder URL - replace with actual)",
        "Set PATH to include ~/.local/bin where gog installs",
        "Use non-root node user for security",
        "WORKDIR should be /home/node (matches OpenClaw sandbox defaults)",
        "Tag final image as openclaw-sandbox:bookworm-slim (matches agent-creator config)"
      ],
      "verification_steps": [
        {
          "command": "grep -q 'FROM node:22-bookworm-slim' /Users/jp/CodingProjects/DonClaudioBot/config/sandbox/Dockerfile.sandbox && grep -q 'gog' /Users/jp/CodingProjects/DonClaudioBot/config/sandbox/Dockerfile.sandbox",
          "expected_output": "exit code 0",
          "status": "passed"
        },
        {
          "command": "grep -q 'WORKDIR /home/node' /Users/jp/CodingProjects/DonClaudioBot/config/sandbox/Dockerfile.sandbox",
          "expected_output": "exit code 0",
          "status": "passed"
        }
      ],
      "completed_at": "2026-02-01",
      "comments": "Dockerfile.sandbox created at config/sandbox/Dockerfile.sandbox (8 LOC). Uses node:22-bookworm-slim base image, installs curl/git/jq, installs gog CLI via official GitHub releases (steipete/gog), sets PATH for ~/.local/bin, copies dedicated agent templates, runs as node user. POST-AUDIT FIX: Replaced placeholder URL with official download from https://github.com/steipete/gog/releases/latest/download/gog_Linux_x86_64.tar.gz per OpenClaw GCP docs pattern."
    },
    {
      "id": "P2-004",
      "title": "Create sandbox build script",
      "status": "completed",
      "priority": "P2",
      "dependencies": ["P2-003"],
      "description": "Create /Users/jp/CodingProjects/DonClaudioBot/scripts/build-sandbox.sh bash script to build sandbox image. #!/bin/bash. set -e. IMAGE_NAME='openclaw-sandbox:bookworm-slim'. DOCKERFILE='config/sandbox/Dockerfile.sandbox'. echo 'Building sandbox image: $IMAGE_NAME...'. docker build -f \"$DOCKERFILE\" -t \"$IMAGE_NAME\" . echo 'Sandbox image built successfully: $IMAGE_NAME'. echo 'To verify: docker run --rm $IMAGE_NAME gog --version'. Make executable with chmod +x. This script builds the sandbox Docker image with gog CLI pre-installed for use in agent sandboxes.",
      "context": {
        "read_files": [],
        "edit_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/scripts/build-sandbox.sh"
        ]
      },
      "constraints": [
        "Use 'set -e' to exit on any error (fail-fast)",
        "Image name must match agent-creator.ts config: openclaw-sandbox:bookworm-slim",
        "Dockerfile path relative to project root: config/sandbox/Dockerfile.sandbox",
        "Build context should be project root (.) for COPY commands to work",
        "Log progress with echo statements",
        "Include verification command in output message (gog --version)"
      ],
      "verification_steps": [
        {
          "command": "grep -q 'set -e' /Users/jp/CodingProjects/DonClaudioBot/scripts/build-sandbox.sh && grep -q 'docker build' /Users/jp/CodingProjects/DonClaudioBot/scripts/build-sandbox.sh",
          "expected_output": "exit code 0",
          "status": "passed"
        },
        {
          "command": "grep -q 'openclaw-sandbox:bookworm-slim' /Users/jp/CodingProjects/DonClaudioBot/scripts/build-sandbox.sh",
          "expected_output": "exit code 0",
          "status": "passed"
        },
        {
          "command": "test -x /Users/jp/CodingProjects/DonClaudioBot/scripts/build-sandbox.sh",
          "expected_output": "exit code 0",
          "status": "passed"
        }
      ],
      "completed_at": "2026-02-01",
      "comments": "Build script created at scripts/build-sandbox.sh (8 LOC). Simple bash wrapper with set -e fail-fast, builds openclaw-sandbox:bookworm-slim image from Dockerfile.sandbox, logs progress, includes verification command. All 3 verification steps passed."
    },
    {
      "id": "P0-012",
      "title": "Fix TypeScript compilation error in integration tests",
      "status": "pending",
      "priority": "P0",
      "dependencies": [],
      "description": "Fix TypeScript compilation error in /Users/jp/CodingProjects/DonClaudioBot/onboarding/src/__tests__/onboarding.flow.test.ts line 15. Error: 'TS2698: Spread types may only be created from object types' when spreading `actual` in vi.mock(). The issue is that `await importOriginal()` returns `unknown` type, which cannot be spread. Fix by casting to `Record<string, unknown>` before spreading: 'const actual = await importOriginal() as Record<string, unknown>;'. Alternative fix: Replace spread with explicit object definition that only overrides specific exports.",
      "context": {
        "read_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/__tests__/onboarding.flow.test.ts"
        ],
        "edit_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/__tests__/onboarding.flow.test.ts"
        ]
      },
      "constraints": [
        "Must preserve vi.mock() structure for vitest mocking",
        "All mocked functions (getState, createAgent) must remain properly mocked",
        "Fix should be surgical - only change the type cast or spread pattern",
        "Do not modify test logic - only fix TypeScript compilation",
        "After fix, 'npm run build' must succeed with exit code 0",
        "After fix, 'npm test' must run all 4 tests successfully"
      ],
      "verification_steps": [
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && npx tsc --noEmit",
          "expected_output": "exit code 0",
          "note": "TypeScript must compile without errors"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && npm test",
          "expected_output": "All 4 tests pass",
          "note": "Test suite must run successfully"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && npm run build",
          "expected_output": "exit code 0",
          "note": "Production build must succeed"
        }
      ],
      "severity": "CRITICAL",
      "blocker_reason": "Blocks deployment - build is broken, cannot create production artifact",
      "source": "Three-agent code review 2026-02-01 - Code Review Agent finding"
    },
    {
      "id": "P0-013",
      "title": "Add Docker security hardening to docker-compose.yml",
      "status": "pending",
      "priority": "P0",
      "dependencies": [],
      "description": "Add security mitigations to /Users/jp/CodingProjects/DonClaudioBot/docker/docker-compose.yml per ARCHITECTURE_REPORT.md section 13.5 Phase 1 mitigations. The Docker socket mount (/var/run/docker.sock:/var/run/docker.sock) is a CRITICAL security risk. Add: (1) user: '1000:1000' to run as non-root, (2) cap_drop: [ALL] to drop all Linux capabilities, (3) security_opt: [no-new-privileges:true] to prevent privilege escalation, (4) read_only: true for read-only root filesystem (optional, may break tmp writes). These mitigations reduce container breakout risk. Reference: ARCHITECTURE_REPORT.md Section 13.5 Docker Socket Risk Mitigation.",
      "context": {
        "read_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/ARCHITECTURE_REPORT.md (section 13.5 Docker Socket Risk Mitigation)",
          "/Users/jp/CodingProjects/DonClaudioBot/docker/docker-compose.yml"
        ],
        "edit_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/docker/docker-compose.yml"
        ]
      },
      "constraints": [
        "Add user directive under service definition: user: '1000:1000'",
        "Add cap_drop directive: cap_drop: [ALL]",
        "Add security_opt: [no-new-privileges:true]",
        "Do NOT remove Docker socket mount - OpenClaw needs it for sandbox spawning",
        "If using read_only: true, add tmpfs mounts for /tmp and writable paths",
        "Test container starts successfully after changes",
        "Verify container runs as non-root (check with 'docker exec don-claudio-bot id')"
      ],
      "verification_steps": [
        {
          "command": "grep -q \"user: '1000:1000'\" /Users/jp/CodingProjects/DonClaudioBot/docker/docker-compose.yml",
          "expected_output": "exit code 0"
        },
        {
          "command": "grep -q 'cap_drop:' /Users/jp/CodingProjects/DonClaudioBot/docker/docker-compose.yml && grep -q 'security_opt:' /Users/jp/CodingProjects/DonClaudioBot/docker/docker-compose.yml",
          "expected_output": "exit code 0"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/docker && docker compose config > /dev/null 2>&1",
          "expected_output": "exit code 0",
          "note": "Compose config must be valid YAML"
        }
      ],
      "severity": "CRITICAL",
      "blocker_reason": "Docker socket mount without hardening is a production security vulnerability - container escape gives host root access",
      "source": "Three-agent code review 2026-02-01 - Implementation Audit Agent critical finding"
    },
    {
      "id": "P0-014",
      "title": "Add rate limiting to webhook endpoint",
      "status": "pending",
      "priority": "P0",
      "dependencies": [],
      "description": "Add rate limiting middleware to /Users/jp/CodingProjects/DonClaudioBot/onboarding/src/routes/webhook.ts to prevent DoS attacks. Install express-rate-limit package: 'npm install express-rate-limit @types/express-rate-limit'. Import rateLimit from 'express-rate-limit'. Create rateLimiter = rateLimit({ windowMs: 60000, max: 10, message: 'Too many requests', standardHeaders: true, legacyHeaders: false }). Apply to POST /webhook/onboarding: router.post('/webhook/onboarding', rateLimiter, webhookAuth, handler). This limits to 10 requests per minute per IP address, preventing abuse while allowing legitimate retries.",
      "context": {
        "read_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/ARCHITECTURE_REPORT.md (section 13.9 Security Checklist - High Priority)",
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/routes/webhook.ts"
        ],
        "edit_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/routes/webhook.ts",
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/package.json"
        ]
      },
      "constraints": [
        "Install express-rate-limit and @types/express-rate-limit as dependencies",
        "Rate limit: 10 requests per minute (windowMs: 60000, max: 10)",
        "Apply rateLimiter middleware BEFORE webhookAuth (order matters)",
        "Include 'X-RateLimit-*' headers in response (standardHeaders: true)",
        "Return 429 status with 'Too many requests' message when limit exceeded",
        "Log rate limit violations: console.warn('[ratelimit] IP exceeded rate limit')"
      ],
      "verification_steps": [
        {
          "command": "grep -q 'express-rate-limit' /Users/jp/CodingProjects/DonClaudioBot/onboarding/package.json",
          "expected_output": "exit code 0"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'rateLimit' src/routes/webhook.ts && grep -q 'windowMs' src/routes/webhook.ts",
          "expected_output": "exit code 0"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && npx tsc --noEmit",
          "expected_output": "exit code 0",
          "note": "TypeScript must compile"
        },
        {
          "command": "for i in {1..12}; do curl -s -X POST -H 'Content-Type: application/json' -d '{\"phone\":\"+15551234567\"}' http://127.0.0.1:3000/webhook/onboarding -o /dev/null -w '%{http_code}\\n'; done | grep -q '429'",
          "expected_output": "exit code 0",
          "note": "11th and 12th requests should return 429 (requires server running)"
        }
      ],
      "severity": "CRITICAL",
      "blocker_reason": "Webhook endpoint has NO rate limiting - attacker can spam agent creation, exhaust host resources, DoS the service",
      "source": "Three-agent code review 2026-02-01 - Architecture Expert Agent critical risk"
    },
    {
      "id": "P0-015",
      "title": "Create .env.example file for environment configuration",
      "status": "pending",
      "priority": "P0",
      "dependencies": [],
      "description": "Create /Users/jp/CodingProjects/DonClaudioBot/.env.example file documenting all required and optional environment variables. Include: (1) GATEWAY_TOKEN - OpenClaw gateway auth token (generate with: openssl rand -base64 32), (2) HOOK_TOKEN - Webhook authentication token (generate with: openssl rand -base64 32), (3) PORT - Onboarding service port (default: 3000), (4) BAILEYS_SIDECAR_ENABLED - Enable Baileys sidecar (default: false), (5) OPENCLAW_CONFIG_PATH - Path to openclaw.json (default: ~/.openclaw/openclaw.json), (6) OPENCLAW_STATE_DIR - Path to state directory (default: ~/.openclaw). Add comments explaining each variable and security considerations. Add instructions: 'cp .env.example .env && edit .env # Generate fresh tokens with openssl rand -base64 32'",
      "context": {
        "read_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/index.ts",
          "/Users/jp/CodingProjects/DonClaudioBot/config/openclaw.json.template"
        ],
        "edit_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/.env.example"
        ]
      },
      "constraints": [
        "File must be named exactly '.env.example' (not .env - that should be in .gitignore)",
        "All env vars used in code must be documented",
        "Include generation commands for secrets (use openssl rand -base64 32)",
        "Add SECURITY WARNING comment about not committing actual .env file",
        "Include default values in comments (e.g., # PORT=3000)",
        "Add to .gitignore: '.env' (if not already present)"
      ],
      "verification_steps": [
        {
          "command": "test -f /Users/jp/CodingProjects/DonClaudioBot/.env.example",
          "expected_output": "exit code 0"
        },
        {
          "command": "grep -q 'GATEWAY_TOKEN=' /Users/jp/CodingProjects/DonClaudioBot/.env.example && grep -q 'HOOK_TOKEN=' /Users/jp/CodingProjects/DonClaudioBot/.env.example",
          "expected_output": "exit code 0"
        },
        {
          "command": "grep -q 'openssl rand' /Users/jp/CodingProjects/DonClaudioBot/.env.example",
          "expected_output": "exit code 0"
        },
        {
          "command": "grep -q '^\\.env$' /Users/jp/CodingProjects/DonClaudioBot/.gitignore",
          "expected_output": "exit code 0"
        }
      ],
      "severity": "HIGH",
      "blocker_reason": "Cannot deploy without documented environment variables - operators don't know what secrets to generate",
      "source": "Three-agent code review 2026-02-01 - Implementation Audit Agent gap"
    },
    {
      "id": "P0-016",
      "title": "Verify build passes with full test suite",
      "status": "pending",
      "priority": "P0",
      "dependencies": ["P0-012"],
      "description": "After fixing TypeScript compilation (P0-012), run full build and test verification. Execute: (1) cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && npm run build - verify TypeScript compiles to dist/ without errors, (2) npm test - verify all 4 integration tests pass, (3) npm run lint (if script exists) - verify no linting errors, (4) Check dist/index.js exists and is executable. This task confirms the codebase is in a deployable state. If any step fails, create follow-up task to fix. This is a GATEKEEPER task - all must pass before deployment.",
      "context": {
        "read_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/package.json"
        ],
        "edit_files": []
      },
      "constraints": [
        "This task depends on P0-012 (TypeScript fix) - cannot pass until build is fixed",
        "Run 'npm run build' first - must exit with code 0",
        "Run 'npm test' second - all tests must pass (look for 'PASS' in vitest output)",
        "If build fails, P0-012 is not complete - return to that task",
        "If tests fail, investigate and create fix task or update test expectations",
        "Document results: create VERIFY_BUILD_RESULTS.md with build/test output"
      ],
      "verification_steps": [
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && npm run build 2>&1 | tee /tmp/build.log",
          "expected_output": "exit code 0, no TypeScript errors"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && npm test 2>&1 | tee /tmp/test.log",
          "expected_output": "All tests pass (exit code 0)"
        },
        {
          "command": "test -f /Users/jp/CodingProjects/DonClaudioBot/onboarding/dist/index.js && test -x /Users/jp/CodingProjects/DonClaudioBot/onboarding/dist/index.js",
          "expected_output": "exit code 0"
        }
      ],
      "severity": "HIGH",
      "blocker_reason": "Cannot deploy without verified working build - this is the final gatekeeper before production",
      "source": "Three-agent code review 2026-02-01 - consolidated recommendation"
    },
    {
      "id": "P1-007",
      "title": "Add audit logging for security events",
      "status": "pending",
      "priority": "P1",
      "dependencies": [],
      "description": "Implement audit logging per ARCHITECTURE_REPORT.md section 13.9 Critical requirements. Create /Users/jp/CodingProjects/DonClaudioBot/onboarding/src/lib/audit-logger.ts with: (1) logAgentCreation(phone, agentId, success, error?) - logs '[audit:agent:create] phone={phone} agentId={agentId} success={success} error={error}', (2) logConfigChange(action, details) - logs '[audit:config] action={action} details={JSON.stringify(details)}', (3) logTokenAccess(agentId) - logs '[audit:token] agentId={agentId} action=access', (4) logAuthFailure(ip, reason) - logs '[audit:auth] ip={ip} reason={reason}'. Integrate into webhook.ts, agent-creator.ts, config-writer.ts, webhook-auth.ts. Use structured logging (JSON format) for machine parsing.",
      "context": {
        "read_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/ARCHITECTURE_REPORT.md (section 13.9 Security Checklist - Critical)",
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/routes/webhook.ts",
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/services/agent-creator.ts",
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/services/config-writer.ts"
        ],
        "edit_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/lib/audit-logger.ts",
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/routes/webhook.ts",
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/services/agent-creator.ts",
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/services/config-writer.ts",
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/middleware/webhook-auth.ts"
        ]
      },
      "constraints": [
        "All audit logs must use '[audit:category]' prefix for filtering",
        "Include timestamp in ISO 8601 format (new Date().toISOString())",
        "Log to stdout (console.log) - Docker will capture logs",
        "Redact sensitive values: never log HOOK_TOKEN, GOG_KEYRING_PASSWORD, phone numbers partially",
        "Use structured logging: console.log(JSON.stringify({timestamp, category, event, details}))",
        "Integrate logAgentCreation into webhook.ts after createAgent() call",
        "Integrate logConfigChange into config-writer.ts after writeConfigAtomic()",
        "Integrate logAuthFailure into webhook-auth.ts on 401/403 responses"
      ],
      "verification_steps": [
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'audit-logger' src/lib/audit-logger.ts && grep -q 'logAgentCreation' src/lib/audit-logger.ts",
          "expected_output": "exit code 0"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'import.*audit-logger' src/routes/webhook.ts && grep -q 'logAgentCreation' src/routes/webhook.ts",
          "expected_output": "exit code 0"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'logAuthFailure' src/middleware/webhook-auth.ts",
          "expected_output": "exit code 0"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && npx tsc --noEmit",
          "expected_output": "exit code 0"
        }
      ],
      "severity": "HIGH",
      "source": "ARCHITECTURE_REPORT.md Section 13.9 Critical - 'Audit Logging (all agent creations, token access, config changes)'",
      "recommended_before": "Public launch - required for security compliance and incident investigation"
    },
    {
      "id": "P1-008",
      "title": "Add sandbox config validation",
      "status": "pending",
      "priority": "P1",
      "dependencies": [],
      "description": "Implement validateSandboxConfig() function per ARCHITECTURE_REPORT.md section 13.6. Create /Users/jp/CodingProjects/DonClaudioBot/onboarding/src/lib/sandbox-validator.ts with validateSandboxConfig(agentConfig: AgentConfig): void function that: (1) Throws error if sandbox.docker.privileged === true, (2) Throws error if !sandbox.docker.capDrop?.includes('ALL'), (3) Throws error if sandbox.docker.binds?.some(b => b.includes('docker.sock')), (4) Throws error if sandbox.workspaceAccess !== 'ro' && sandbox.workspaceAccess !== 'none', (5) Logs warnings for non-critical issues. Call this function in agent-creator.ts BEFORE addAgentToConfig(). This prevents insecure sandbox configurations from being deployed.",
      "context": {
        "read_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/ARCHITECTURE_REPORT.md (section 13.6 Sandbox Configuration Validation)",
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/services/agent-creator.ts"
        ],
        "edit_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/lib/sandbox-validator.ts",
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/services/agent-creator.ts"
        ]
      },
      "constraints": [
        "validateSandboxConfig() must throw Error with 'CRITICAL:' prefix for security issues",
        "Check privileged: true - throw 'CRITICAL: Privileged mode is NOT allowed'",
        "Check capDrop includes 'ALL' - throw 'CRITICAL: Must drop all capabilities'",
        "Check binds don't include docker.sock - throw 'CRITICAL: Docker socket mount in sandbox'",
        "Check workspaceAccess is 'ro' or 'none' - throw 'CRITICAL: Workspace must be read-only or none'",
        "Call validateSandboxConfig(agentConfig) in agent-creator.ts before addAgentToConfig()",
        "Wrap in try/catch - if validation fails, rollback agent creation"
      ],
      "verification_steps": [
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'validateSandboxConfig' src/lib/sandbox-validator.ts && grep -q 'privileged' src/lib/sandbox-validator.ts",
          "expected_output": "exit code 0"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'import.*sandbox-validator' src/services/agent-creator.ts && grep -q 'validateSandboxConfig' src/services/agent-creator.ts",
          "expected_output": "exit code 0"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && npx tsc --noEmit",
          "expected_output": "exit code 0"
        }
      ],
      "severity": "HIGH",
      "source": "ARCHITECTURE_REPORT.md Section 13.6 - 'Runtime validation that privileged is false, caps dropped, etc.'",
      "recommended_before": "Production deployment - prevents insecure sandbox configurations"
    },
    {
      "id": "P1-009",
      "title": "Implement backup script for state volume",
      "status": "pending",
      "priority": "P1",
      "dependencies": [],
      "description": "Create /Users/jp/CodingProjects/DonClaudioBot/scripts/backup.sh bash script to backup the don-claudio-state Docker volume. Script should: (1) Create backup volume if not exists: docker volume create don-claudio-state-backup, (2) Run backup container: docker run --rm -v don-claudio-state:/from -v don-claudio-state-backup:/to alpine tar czf /to/backup-$(date +%Y%m%d-%H%M%S).tar.gz -C /from ., (3) List backups: docker run --rm -v don-claudio-state-backup:/data alpine ls -lh /data, (4) Retain last 7 backups, delete older ones. Make executable: chmod +x. Reference: DEPLOYMENT.md mentions backup script but doesn't exist. This preserves WhatsApp auth and all state in case of disaster.",
      "context": {
        "read_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/docker/docker-compose.yml",
          "/Users/jp/CodingProjects/DonClaudioBot/DEPLOYMENT.md"
        ],
        "edit_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/scripts/backup.sh"
        ]
      },
      "constraints": [
        "Use 'set -e' for fail-fast error handling",
        "Backup volume name: don-claudio-state-backup",
        "Source volume: don-claudio-state (defined in docker-compose.yml)",
        "Backup filename format: backup-YYYYMMDD-HHMMSS.tar.gz",
        "Use alpine:latest image for tar operations (lightweight)",
        "Retain 7 most recent backups, delete older: 'ls -t | tail -n +8 | xargs rm -f'",
        "Log all actions with echo statements",
        "Add usage instruction: './scripts/backup.sh' to run manually or add to crontab"
      ],
      "verification_steps": [
        {
          "command": "test -f /Users/jp/CodingProjects/DonClaudioBot/scripts/backup.sh && test -x /Users/jp/CodingProjects/DonClaudioBot/scripts/backup.sh",
          "expected_output": "exit code 0"
        },
        {
          "command": "grep -q 'don-claudio-state' /Users/jp/CodingProjects/DonClaudioBot/scripts/backup.sh && grep -q 'backup-' /Users/jp/CodingProjects/DonClaudioBot/scripts/backup.sh",
          "expected_output": "exit code 0"
        },
        {
          "command": "grep -q 'set -e' /Users/jp/CodingProjects/DonClaudioBot/scripts/backup.sh && grep -q 'tar czf' /Users/jp/CodingProjects/DonClaudioBot/scripts/backup.sh",
          "expected_output": "exit code 0"
        },
        {
          "command": "grep -q 'tail -n +8' /Users/jp/CodingProjects/DonClaudioBot/scripts/backup.sh",
          "expected_output": "exit code 0",
          "note": "Retention policy implemented"
        }
      ],
      "severity": "HIGH",
      "source": "DEPLOYMENT.md references scripts/backup.sh but file doesn't exist",
      "recommended_before": "Production deployment - data loss without backups is catastrophic"
    },
    {
      "id": "P1-010",
      "title": "Create deployment checklist and runbook",
      "status": "pending",
      "priority": "P1",
      "dependencies": ["P0-013", "P0-014", "P0-015", "P1-009"],
      "description": "Create /Users/jp/CodingProjects/DonClaudioBot/docs/DEPLOYMENT_CHECKLIST.md documenting production deployment procedures. Include: (1) Pre-deployment checklist (env vars, Docker security, backup, build verification), (2) Step-by-step deployment process with exact commands, (3) Post-deployment verification (health checks, webhook test, WhatsApp auth test), (4) Rollback procedure if deployment fails, (5) Common failure scenarios and recovery steps, (6) Monitoring commands (docker compose logs, volume inspect), (7) Contact/emergency procedures. This is the runbook for operators deploying to Hetzner VPS at 135.181.93.227.",
      "context": {
        "read_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/DEPLOYMENT.md",
          "/Users/jp/CodingProjects/DonClaudioBot/scripts/deploy.sh"
        ],
        "edit_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/docs/DEPLOYMENT_CHECKLIST.md"
        ]
      },
      "constraints": [
        "Format as Markdown with numbered checklist items ([ ] for unchecked, [x] for checked)",
        "Include exact bash commands that can be copy-pasted",
        "Pre-deployment section must verify: .env exists, Docker security applied, backup recent, build passes",
        "Deployment section: step-by-step from ./scripts/deploy.sh to health check",
        "Post-deployment: curl health endpoint, test webhook with curl, verify WhatsApp connected",
        "Rollback section: 'docker compose down && docker volume rollback don-claudio-state-backup && docker compose up -d'",
        "Include common issues: 'Container won't start', 'WhatsApp auth lost', 'Webhook returns 500'",
        "Add 'Emergency Contact' section (even if placeholder)"
      ],
      "verification_steps": [
        {
          "command": "test -f /Users/jp/CodingProjects/DonClaudioBot/docs/DEPLOYMENT_CHECKLIST.md",
          "expected_output": "exit code 0"
        },
        {
          "command": "grep -q 'Pre-deployment' /Users/jp/CodingProjects/DonClaudioBot/docs/DEPLOYMENT_CHECKLIST.md && grep -q 'Rollback' /Users/jp/CodingProjects/DonClaudioBot/docs/DEPLOYMENT_CHECKLIST.md",
          "expected_output": "exit code 0"
        },
        {
          "command": "grep -q 'curl.*health' /Users/jp/CodingProjects/DonClaudioBot/docs/DEPLOYMENT_CHECKLIST.md && grep -q 'webhook' /Users/jp/CodingProjects/DonClaudioBot/docs/DEPLOYMENT_CHECKLIST.md",
          "expected_output": "exit code 0"
        },
        {
          "command": "grep -q 'docker compose logs' /Users/jp/CodingProjects/DonClaudioBot/docs/DEPLOYMENT_CHECKLIST.md",
          "expected_output": "exit code 0"
        }
      ],
      "severity": "HIGH",
      "source": "Three-agent review recommendation - 'Create runbook for common failures'",
      "recommended_before": "Production deployment - operators need documented procedures"
    },
    {
      "id": "P1-011",
      "title": "Schedule reconciliation and OAuth monitoring cron jobs",
      "status": "pending",
      "priority": "P1",
      "dependencies": ["P1-005", "P1-006"],
      "description": "Create /Users/jp/CodingProjects/DonClaudioBot/scripts/cron-setup.sh bash script that configures cron jobs for periodic tasks. Jobs to schedule: (1) Hourly reconciliation: 0 * * * * cd /root/don-claudio-bot/onboarding && node dist/services/reconciliation.js >> /var/log/don-claudio-reconciliation.log 2>&1, (2) Daily OAuth expiry check: 0 2 * * * cd /root/don-claudio-bot/onboarding && node dist/services/oauth-monitor.js >> /var/log/don-claudio-oauth.log 2>&1, (3) Daily backup: 0 3 * * * /root/don-claudio-bot/scripts/backup.sh. Script should add jobs to crontab using 'crontab -l | { cat; echo \"jobs\"; } | crontab -'. Also create logrotate config for log files.",
      "context": {
        "read_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/services/reconciliation.ts",
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/services/oauth-monitor.ts"
        ],
        "edit_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/scripts/cron-setup.sh",
          "/Users/jp/CodingProjects/DonClaudioBot/config/logrotate-don-claudio"
        ]
      },
      "constraints": [
        "Cron jobs must run as root (DonClaudioBot runs as root in container)",
        "Reconciliation: hourly (0 * * * *) - cleans up orphaned agents/stale states",
        "OAuth check: daily at 2 AM (0 2 * * *) - scans for tokens >90 days old",
        "Backup: daily at 3 AM (0 3 * * *) - runs backup.sh script",
        "All cron output must log to /var/log/don-claudio-*.log files",
        "Create logrotate config: /etc/logrotate.d/don-claudio with weekly rotation, keep 4 weeks",
        "cron-setup.sh should be idempotent - can run multiple times safely",
        "Add 'crontab -l' output at end of script to verify jobs installed"
      ],
      "verification_steps": [
        {
          "command": "test -f /Users/jp/CodingProjects/DonClaudioBot/scripts/cron-setup.sh && test -x /Users/jp/CodingProjects/DonClaudioBot/scripts/cron-setup.sh",
          "expected_output": "exit code 0"
        },
        {
          "command": "grep -q 'reconciliation' /Users/jp/CodingProjects/DonClaudioBot/scripts/cron-setup.sh && grep -q 'oauth-monitor' /Users/jp/CodingProjects/DonClaudioBot/scripts/cron-setup.sh",
          "expected_output": "exit code 0"
        },
        {
          "command": "grep -q '0 \\* \\* \\* \\*' /Users/jp/CodingProjects/DonClaudioBot/scripts/cron-setup.sh && grep -q 'backup.sh' /Users/jp/CodingProjects/DonClaudioBot/scripts/cron-setup.sh",
          "expected_output": "exit code 0"
        },
        {
          "command": "test -f /Users/jp/CodingProjects/DonClaudioBot/config/logrotate-don-claudio",
          "expected_output": "exit code 0"
        }
      ],
      "severity": "MEDIUM",
      "source": "P1-005 and P1-006 exist but aren't automated - need cron scheduling",
      "recommended_before": "Production deployment - without automation, these manual tasks will be forgotten"
    }
  ]
}
