{
  "project_name": "DonClaudioBot v2",
  "version": "2.2.0",
  "last_updated": "2026-01-31",
  "design_notes": {
    "critical_investigation_required": {
      "issue": "Hook trigger mechanism unclear",
      "severity": "HIGH - Architectural assumption at risk",
      "description": "The architecture assumes 'command:new' triggers on new WhatsApp messages, but QMD docs show OpenClaw hooks fire on agent commands (/new, /reset, /stop), not incoming messages. The onboarding trigger may need to be a channel-level event listener or Baileys 'messages.upsert' handler, not a hook.",
      "action_required": "Before implementing P1-004, investigate how to trigger automation on new incoming WhatsApp message from unknown user. Search OpenClaw docs for 'messages.upsert', 'channel events', or 'inbox listener'.",
      "fallback": "P1-004 now includes manual webhook testing as interim solution while trigger mechanism is clarified.",
      "recommendation": "Consider running P1-003 as a spike BEFORE P0 implementation to de-risk this assumption early."
    },
    "qmd_verification_2026_01_31": {
      "verified_by": "Principal Engineer Review",
      "openclaw_hooks_finding": {
        "source": "openclaw-reference/hooks.md",
        "current_events": ["command:new", "command:reset", "command:stop", "agent:bootstrap", "gateway:startup"],
        "future_events_not_implemented": ["session:start", "session:end", "agent:error", "message:sent", "message:received"],
        "impact": "message:received is listed as PLANNED but NOT IMPLEMENTED. This confirms the trigger mechanism concern is valid."
      },
      "openclaw_cli_verified": {
        "source": "openclaw-reference/cli/agents.md",
        "commands_confirmed": ["openclaw agents add <name>", "openclaw agents list --bindings", "openclaw agents delete <id>"]
      },
      "binding_format_verified": {
        "source": "openclaw-reference/concepts/multi-agent.md",
        "correct_format": "{agentId: string, match: {channel: 'whatsapp', peer: {kind: 'dm', id: '+15551234567'}}}"
      },
      "gateway_reload_verified": {
        "source": "openclaw-reference/gateway/configuration.md",
        "hot_reload_supported": true,
        "agents_bindings_hot_reloadable": true
      }
    },
    "changes_from_v2.0.0": [
      "Added P0-009: openclaw.json.template (required for CLI to work)",
      "Merged P1-001 transactional pattern into P0-006 constraints (build correctness in from day one)",
      "Converted old P1-001 to P1-007 (simplified - just adds rollback logging)",
      "Modified P1-004: Now investigation + documentation task with warning about hook mechanism",
      "Enhanced P0-008 verification: Added functional server startup test"
    ],
    "changes_from_v2.1.0": [
      "Added qmd_verification_2026_01_31 with OpenClaw documentation verification results",
      "Enhanced P0-006 with CLI existence check, explicit agentConfig schema, and command timeouts",
      "Updated P1-003 with specific QMD findings about message:received being unimplemented",
      "Added implementation_guidance section with cross-cutting concerns"
    ]
  },
  "implementation_guidance": {
    "for_all_agents": [
      "Run 'npx tsc --noEmit' after each file change to catch TypeScript errors early",
      "All CLI commands should use {timeout: 30000} to prevent hanging",
      "Before using OpenClaw CLI, verify it's installed: execAsync('openclaw --version')",
      "Temp files should be written to same directory as target (for atomic rename to work)",
      "Use 127.0.0.1 instead of localhost to avoid IPv6 resolution issues"
    ],
    "error_handling_philosophy": "Fail fast and loud. Let errors crash with full stack traces. Rollback in reverse order of operations. Always re-throw after cleanup.",
    "testing_reminder": "The webhook can be tested manually at any point with: curl -X POST -H 'Authorization: Bearer $HOOK_TOKEN' -H 'Content-Type: application/json' -d '{\"phone\":\"+15551234567\"}' http://127.0.0.1:3000/webhook/onboarding"
  },
  "tasks": [
    {
      "id": "P0-001",
      "title": "Create Zod validation schemas for E.164 phone and agent ID",
      "status": "pending",
      "priority": "P0",
      "dependencies": [],
      "description": "Create /Users/jp/CodingProjects/DonClaudioBot/onboarding/src/lib/validation.ts with Zod schemas: (1) E164PhoneSchema - regex /^\\+[1-9]\\d{1,14}$/ for E.164 format (ITU-T E.164 standard), (2) AgentIdSchema - regex /^user_[a-zA-Z0-9_-]+$/, min 5 max 64 chars, (3) OnboardingWebhookSchema - object with phone (E164PhoneSchema) and optional timestamp. Export both schemas and infer TypeScript types using z.infer<>.",
      "context": {
        "read_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/ARCHITECTURE_REPORT.md (section 13.4 Input Validation)"
        ],
        "edit_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/lib/validation.ts"
        ]
      },
      "constraints": [
        "Use zod@^3.22.0 from package.json dependencies",
        "No 'any' types - use z.infer<> to derive TypeScript types from schemas",
        "E.164 regex must require leading + followed by 1-14 digits (country code 1-9, not 0)",
        "Export TypeOf<> versions: type E164Phone = z.infer<typeof E164PhoneSchema>"
      ],
      "verification_steps": [
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && npx tsc --noEmit",
          "expected_output": "exit code 0"
        },
        {
          "command": "grep -q 'export.*E164PhoneSchema' src/lib/validation.ts && grep -q 'export.*AgentIdSchema' src/lib/validation.ts",
          "expected_output": "exit code 0"
        },
        {
          "command": "grep -q 'z.infer' src/lib/validation.ts",
          "expected_output": "exit code 0"
        }
      ]
    },
    {
      "id": "P0-002",
      "title": "Implement SQLite database schema with migrations",
      "status": "pending",
      "priority": "P0",
      "dependencies": [],
      "description": "Replace placeholder /Users/jp/CodingProjects/DonClaudioBot/onboarding/src/db/schema.sql with complete schema from ARCHITECTURE_REPORT.md. Include: (1) PRAGMA journal_mode=WAL, foreign_keys=ON, busy_timeout=5000, (2) onboarding_states table with phone_number TEXT NOT NULL UNIQUE, agent_id TEXT NOT NULL UNIQUE, status TEXT DEFAULT 'new', name, email, created_at, updated_at, expires_at, CHECK(phone_number LIKE '+%'), (3) state_transitions table for audit trail with phone_number, from_status, to_status, transitioned_at, (4) Indexes: idx_phone_lookup (WHERE status != 'cancelled'), idx_agent_lookup, idx_expiration, (5) Trigger update_updated_at for auto-timestamp.",
      "context": {
        "read_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/ARCHITECTURE_REPORT.md (section 11.3 Database Schema)"
        ],
        "edit_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/db/schema.sql"
        ]
      },
      "constraints": [
        "Use better-sqlite3 package from dependencies",
        "WAL mode for concurrent readers (PRAGMA journal_mode = WAL)",
        "UNIQUE constraints on phone_number and agent_id to prevent duplicates",
        "5 second busy_timeout for lock retries (PRAGMA busy_timeout = 5000)",
        "CHECK constraint ensures phone_number starts with '+'"
      ],
      "verification_steps": [
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'PRAGMA journal_mode = WAL' src/db/schema.sql && grep -q 'phone_number TEXT NOT NULL UNIQUE' src/db/schema.sql",
          "expected_output": "exit code 0"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'idx_phone_lookup' src/db/schema.sql && grep -q 'idx_agent_lookup' src/db/schema.sql",
          "expected_output": "exit code 0"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'CHECK(phone_number LIKE' src/db/schema.sql",
          "expected_output": "exit code 0"
        }
      ]
    },
    {
      "id": "P0-003",
      "title": "Implement state-manager with SQLite CRUD operations",
      "status": "pending",
      "priority": "P0",
      "dependencies": ["P0-002"],
      "description": "Implement /Users/jp/CodingProjects/DonClaudioBot/onboarding/src/services/state-manager.ts replacing placeholder. Import Database from 'better-sqlite3'. Define OnboardingState interface matching schema. Implement: (1) initDatabase() - opens ~/.openclaw/onboarding.db with {timeout: 5000}, reads and executes schema.sql, (2) getState(phone) - returns row or null using prepared statement 'SELECT * FROM onboarding_states WHERE phone_number = ?', (3) createState(phone, agentId, status='new') - INSERT with expires_at = datetime('now', '+24 hours'), (4) updateState(phone, updates) - UPDATE with partial fields, (5) setStatus(phone, status) - transition with audit log entry to state_transitions, (6) getByAgentId(agentId) - lookup by agent. All queries parameterized, no string interpolation.",
      "context": {
        "read_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/services/state-manager.ts",
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/db/schema.sql"
        ],
        "edit_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/services/state-manager.ts"
        ]
      },
      "constraints": [
        "Use better-sqlite3 sync API (not async wrapper) - Database constructor returns sync connection",
        "All SQL queries must use prepared statements with ? placeholders (no string interpolation)",
        "DB path: process.env.OPENCLAW_STATE_DIR + '/onboarding.db' or '~/.openclaw/onboarding.db'",
        "Begin IMMEDIATE transactions for writes (db.transaction(() => { ... })",
        "Return null from getState() when phone not found (don't throw)"
      ],
      "verification_steps": [
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && npx tsc --noEmit",
          "expected_output": "exit code 0",
          "note": "TypeScript compilation check - run after every file change"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'prepare(' src/services/state-manager.ts && ! grep -q \"SELECT.*phone_number = '\\${\" src/services/state-manager.ts",
          "expected_output": "exit code 0"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'better-sqlite3' src/services/state-manager.ts && grep -q 'Database(' src/services/state-manager.ts",
          "expected_output": "exit code 0"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'transaction(' src/services/state-manager.ts",
          "expected_output": "exit code 0"
        }
      ]
    },
    {
      "id": "P0-004",
      "title": "Implement webhook authentication middleware",
      "status": "pending",
      "priority": "P0",
      "dependencies": [],
      "description": "Create /Users/jp/CodingProjects/DonClaudioBot/onboarding/src/middleware/webhook-auth.ts implementing shared token auth (DP7 security decision). Export webhookAuth(req, res, next) function that: (1) Checks req.headers.authorization exists and starts with 'Bearer ', (2) Extracts token via authHeader.substring(7), (3) Compares to process.env.HOOK_TOKEN using ===, (4) Returns res.status(401).json({error: 'Missing authorization header'}) if missing, (5) Returns res.status(403).json({error: 'Invalid token'}) if invalid, (6) Logs console.error('[webhook] Failed auth attempt from ' + req.ip) for failures, (7) Calls next() on success. Import Request, Response, NextFunction from 'express'.",
      "context": {
        "read_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/ARCHITECTURE_REPORT.md (section 13.3 Webhook Security)"
        ],
        "edit_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/middleware/webhook-auth.ts"
        ]
      },
      "constraints": [
        "Must use Request, Response, NextFunction types from express",
        "Return 401 for missing Authorization header, 403 for invalid token",
        "Do not log the actual token value (security - prevent token leakage in logs)",
        "Constant-time comparison not required for MVP per DP7 (use ===)",
        "Check authHeader?.startsWith('Bearer ') to handle undefined safely"
      ],
      "verification_steps": [
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && npx tsc --noEmit",
          "expected_output": "exit code 0",
          "note": "TypeScript compilation check - run after every file change"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q \"req.headers.authorization\" src/middleware/webhook-auth.ts && grep -q \"status(401)\" src/middleware/webhook-auth.ts",
          "expected_output": "exit code 0"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q \"status(403)\" src/middleware/webhook-auth.ts && grep -q \"HOOK_TOKEN\" src/middleware/webhook-auth.ts",
          "expected_output": "exit code 0"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q \"Failed auth attempt\" src/middleware/webhook-auth.ts",
          "expected_output": "exit code 0"
        }
      ]
    },
    {
      "id": "P0-005",
      "title": "Implement atomic config-writer service",
      "status": "pending",
      "priority": "P0",
      "dependencies": [],
      "description": "Create /Users/jp/CodingProjects/DonClaudioBot/onboarding/src/services/config-writer.ts for atomic openclaw.json updates (DP1 resolution). Implement: (1) getConfigPath() - returns process.env.OPENCLAW_CONFIG_PATH or '~/.openclaw/openclaw.json', (2) readConfig() - reads file, parses with JSON5.parse, returns object, (3) writeConfigAtomic(config) - writes to './openclaw.json.tmp_' + Date.now(), then fs.rename() for atomicity, (4) addAgentToConfig(agentConfig, phoneNumber) - adds agent to agents.list array and binding {agentId, match: {channel: 'whatsapp', peer: {kind: 'dm', id: phoneNumber}}} to bindings array, (5) backupConfig() - copies to './openclaw.json.backup_' + Date.now(), (6) restoreBackup(backupPath) - moves backup to config. Use proper-lockfile with {retries: 3, minTimeout: 100, stale: 5000} on config file during writes.",
      "context": {
        "read_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/ARCHITECTURE_REPORT.md (section 11.1 OpenClaw Integration)"
        ],
        "edit_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/services/config-writer.ts"
        ]
      },
      "constraints": [
        "Use JSON5.parse() to read config (not JSON.parse - openclaw.json allows comments/trailing commas)",
        "Atomic write: temp file + rename (not direct overwrite) - fs.rename() is atomic on POSIX",
        "Use proper-lockfile package on config file during writes with retries",
        "Config path: process.env.OPENCLAW_CONFIG_PATH or '~/.openclaw/openclaw.json'",
        "Backup must preserve original file permissions (use fs.copyFile with mode)",
        "Binding format must match: {agentId: string, match: {channel: 'whatsapp', peer: {kind: 'dm', id: phone}}}"
      ],
      "verification_steps": [
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && npx tsc --noEmit",
          "expected_output": "exit code 0",
          "note": "TypeScript compilation check - run after every file change"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'proper-lockfile' src/services/config-writer.ts && grep -q 'rename' src/services/config-writer.ts",
          "expected_output": "exit code 0"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'JSON5' src/services/config-writer.ts && grep -q 'tmp_' src/services/config-writer.ts",
          "expected_output": "exit code 0"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'backup_' src/services/config-writer.ts",
          "expected_output": "exit code 0"
        }
      ]
    },
    {
      "id": "P0-006",
      "title": "Implement agent-creator CLI wrapper with transactional rollback",
      "status": "pending",
      "priority": "P0",
      "dependencies": ["P0-001", "P0-005"],
      "description": "Implement /Users/jp/CodingProjects/DonClaudioBot/onboarding/src/services/agent-creator.ts with createAgent() and agentExists(). Import {exec} from 'child_process' and promisify. Implement createAgent(options) with BUILT-IN ROLLBACK: (1) Validate phone via E164PhoneSchema.parse(options.phoneNumber), (2) Generate agentId = 'user_' + randomBytes(8).toString('hex'), (3) Track state: let agentCreated = false, let configUpdated = false, let backupPath = null, (4) In try block: run 'openclaw agents add ' + agentId, set agentCreated = true, (5) backupPath = await backupConfig(), (6) Build agentConfig and call addAgentToConfig(agentConfig, options.phoneNumber), set configUpdated = true, (7) Run 'openclaw gateway reload', (8) Return agentId. In catch block: if (configUpdated && backupPath) await restoreBackup(backupPath), if (agentCreated) await execAsync('openclaw agents remove ' + agentId), then re-throw error. Implement agentExists(agentId): readConfig(), check agents.list.find(a => a.id === agentId).",
      "context": {
        "read_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/services/agent-creator.ts",
          "/Users/jp/CodingProjects/DonClaudioBot/ARCHITECTURE_REPORT.md (section 12.3 Transactional Creation Pattern)"
        ],
        "edit_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/services/agent-creator.ts"
        ]
      },
      "constraints": [
        "PREREQUISITE: Before ANY CLI call, verify openclaw is installed with: await execAsync('openclaw --version', {timeout: 5000}). Throw clear error if not found.",
        "Use 'openclaw agents add {agentId}' CLI command (DP1 resolution)",
        "Generate unique agentId: 'user_' + 16 hex chars from crypto.randomBytes(8)",
        "All execAsync calls MUST use {timeout: 30000} (30 seconds) to prevent hanging",
        "Sandbox config: mode='all', scope='agent', workspaceAccess='ro', network='bridge'",
        "Generate unique GOG_KEYRING_PASSWORD per agent using crypto.randomBytes(32).toString('base64url')",
        "Use 'openclaw gateway reload' after config update (hot reload per DP1)",
        "MUST implement rollback: track agentCreated/configUpdated flags, reverse on failure (DP6)",
        "Rollback order: restore config backup FIRST, then remove agent",
        "Use 'openclaw agents remove {agentId}' for cleanup on failure",
        "Always re-throw error after rollback (don't swallow - caller needs to know)",
        "Read config-writer.ts functions for config operations (don't reimplement)"
      ],
      "agentConfig_schema": {
        "note": "This is the exact shape to pass to addAgentToConfig()",
        "shape": {
          "id": "user_<16hexchars>",
          "name": "User Agent",
          "workspace": "~/.openclaw/workspace-user_<id>",
          "agentDir": "~/.openclaw/agents/user_<id>/agent",
          "sandbox": {
            "mode": "all",
            "scope": "agent",
            "workspaceAccess": "ro",
            "docker": {
              "image": "openclaw-sandbox:bookworm-slim",
              "network": "bridge",
              "env": {
                "GOG_KEYRING_PASSWORD": "<unique-base64url-string>",
                "GOG_CONFIG_DIR": "/home/node/.gog/plus_<phone>"
              }
            }
          }
        }
      },
      "verification_steps": [
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && npx tsc --noEmit",
          "expected_output": "exit code 0",
          "note": "TypeScript compilation check - run after every file change"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'openclaw agents add' src/services/agent-creator.ts && grep -q 'openclaw gateway reload' src/services/agent-creator.ts",
          "expected_output": "exit code 0"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'randomBytes' src/services/agent-creator.ts && grep -q 'GOG_KEYRING_PASSWORD' src/services/agent-creator.ts",
          "expected_output": "exit code 0"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'agentCreated' src/services/agent-creator.ts && grep -q 'configUpdated' src/services/agent-creator.ts",
          "expected_output": "exit code 0"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'openclaw agents remove' src/services/agent-creator.ts && grep -q 'restoreBackup' src/services/agent-creator.ts",
          "expected_output": "exit code 0"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'openclaw --version' src/services/agent-creator.ts",
          "expected_output": "exit code 0",
          "note": "Verify CLI existence check is implemented"
        }
      ]
    },
    {
      "id": "P0-007",
      "title": "Implement webhook route POST /webhook/onboarding",
      "status": "pending",
      "priority": "P0",
      "dependencies": ["P0-003", "P0-004", "P0-006"],
      "description": "Implement /Users/jp/CodingProjects/DonClaudioBot/onboarding/src/routes/webhook.ts. Import express, {Router, Request, Response}, webhookAuth, OnboardingWebhookSchema, getState, createAgent, createState. Export router = Router(). POST /webhook/onboarding with webhookAuth middleware. Handler: (1) Try const {phone} = OnboardingWebhookSchema.parse(req.body), catch ZodError return res.status(400).json({error: 'Invalid phone format', details: error.errors}), (2) const existing = await getState(phone); if (existing && existing.status !== 'cancelled') return res.status(200).json({status: 'existing', agentId: existing.agent_id}), (3) const agentId = await createAgent({phoneNumber: phone}), (4) await createState(phone, agentId, 'new'), (5) return res.status(201).json({status: 'created', agentId, phone}). Catch errors return res.status(500).json({error: error.message}).",
      "context": {
        "read_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/routes/webhook.ts",
          "/Users/jp/CodingProjects/DonClaudioBot/ARCHITECTURE_REPORT.md (section 6.3 Onboarding Service API)"
        ],
        "edit_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/routes/webhook.ts"
        ]
      },
      "constraints": [
        "Use express.Router() for routing",
        "Apply webhookAuth middleware before handler (security DP7)",
        "Validate input with OnboardingWebhookSchema.parse() - catches ZodError",
        "Return 200 for existing agents (idempotent), 201 for new, 400 for validation errors, 401/403 from auth middleware, 500 for server errors",
        "Include agentId in all success responses for tracking",
        "Log '[webhook] Processing onboarding for phone:' + phone at start"
      ],
      "verification_steps": [
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q \"router.post('/webhook/onboarding'\" src/routes/webhook.ts && grep -q 'webhookAuth' src/routes/webhook.ts",
          "expected_output": "exit code 0"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'OnboardingWebhookSchema' src/routes/webhook.ts && grep -q 'createAgent' src/routes/webhook.ts",
          "expected_output": "exit code 0"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'ZodError' src/routes/webhook.ts",
          "expected_output": "exit code 0"
        }
      ]
    },
    {
      "id": "P0-008",
      "title": "Implement Express server entry point",
      "status": "pending",
      "priority": "P0",
      "dependencies": ["P0-007"],
      "description": "Implement /Users/jp/CodingProjects/DonClaudioBot/onboarding/src/index.ts as Express entry point. Import express, webhookRouter. Create const app = express(). Use app.use(express.json()) middleware. Import initDatabase and call initDatabase() before starting server (await top-level or .then()). Mount webhook router at app.use('/', webhookRouter). Define const PORT = process.env.PORT || 3000. Add app.get('/health', (req, res) => res.json({status: 'ok', timestamp: new Date().toISOString()})). Add startup validation: if (!process.env.HOOK_TOKEN) console.warn('[WARN] HOOK_TOKEN not set - webhook endpoint is insecure!'). Start server with app.listen(PORT, () => console.log('Onboarding service listening on port', PORT)). Export app for testing.",
      "context": {
        "read_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/index.ts"
        ],
        "edit_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/index.ts"
        ]
      },
      "constraints": [
        "Use express@^4.19.0 from dependencies",
        "JSON body parser with express.json() middleware",
        "Health check endpoint must return ISO 8601 timestamp (new Date().toISOString())",
        "Log startup message to console with port number",
        "Default port 3000, configurable via PORT env var",
        "Export app for testing purposes (export default app)",
        "Initialize database before server starts (await initDatabase() at top-level with ES modules or wrap in .then())"
      ],
      "verification_steps": [
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q \"app.listen(PORT\" src/index.ts && grep -q \"/health\" src/index.ts",
          "expected_output": "exit code 0"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'express.json()' src/index.ts && grep -q 'webhook' src/index.ts",
          "expected_output": "exit code 0"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'initDatabase' src/index.ts",
          "expected_output": "exit code 0"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && npm run build && (timeout 3 node dist/index.js &) && sleep 2 && curl -sf http://127.0.0.1:3000/health | grep -q 'ok' || echo 'Server health check passed'",
          "expected_output": "exit code 0",
          "note": "Functional test: server starts and health endpoint responds"
        }
      ]
    },
    {
      "id": "P0-009",
      "title": "Create openclaw.json.template base configuration",
      "status": "pending",
      "priority": "P0",
      "dependencies": [],
      "description": "Create /Users/jp/CodingProjects/DonClaudioBot/config/openclaw.json.template with base OpenClaw configuration. Include: (1) gateway: {mode: 'local', bind: 'ws://127.0.0.1:18789'}, (2) agents: {defaults: {workspace: '~/.openclaw/workspace', sandbox: {mode: 'off'}}, list: [{id: 'onboarding', name: 'Onboarding Agent', workspace: '~/.openclaw/workspace-onboarding', default: true, sandbox: {mode: 'off'}}]}, (3) bindings: [{agentId: 'onboarding', match: {channel: 'whatsapp'}}] (catch-all for new users), (4) channels: {whatsapp: {allowFrom: ['*'], dmPolicy: 'allowlist'}}, (5) session: {dmScope: 'per-channel-peer'} (CRITICAL for isolation), (6) hooks: {enabled: true, token: '${HOOK_TOKEN}'}. This template is copied to ~/.openclaw/openclaw.json during setup.",
      "context": {
        "read_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/ARCHITECTURE_REPORT.md (Appendix A.3 Configuration Reference)"
        ],
        "edit_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/config/openclaw.json.template"
        ]
      },
      "constraints": [
        "Use JSON5 format (comments allowed for documentation)",
        "dmScope MUST be 'per-channel-peer' for session isolation (security critical)",
        "Onboarding agent must be marked default: true (catch-all)",
        "Onboarding agent sandbox: off (no sandboxing for intake)",
        "Placeholder ${HOOK_TOKEN} for setup.sh to replace with actual token",
        "WhatsApp channel with dmPolicy: 'allowlist' for security"
      ],
      "verification_steps": [
        {
          "command": "test -f /Users/jp/CodingProjects/DonClaudioBot/config/openclaw.json.template",
          "expected_output": "exit code 0"
        },
        {
          "command": "grep -q 'per-channel-peer' /Users/jp/CodingProjects/DonClaudioBot/config/openclaw.json.template",
          "expected_output": "exit code 0"
        },
        {
          "command": "grep -q 'onboarding' /Users/jp/CodingProjects/DonClaudioBot/config/openclaw.json.template && grep -q 'default.*true' /Users/jp/CodingProjects/DonClaudioBot/config/openclaw.json.template",
          "expected_output": "exit code 0"
        }
      ]
    },
    {
      "id": "P1-001",
      "title": "Add phone number normalization utility",
      "status": "pending",
      "priority": "P1",
      "dependencies": ["P0-001"],
      "description": "Create /Users/jp/CodingProjects/DonClaudioBot/onboarding/src/lib/phone-normalizer.ts. Implement function normalizePhoneNumber(raw: string): string that: (1) Strips all non-digit characters except leading + using raw.replace(/[^+\\d]/g, ''), (2) Validates result with E164PhoneSchema.parse(), (3) Returns normalized string, (4) Throws ZodError if invalid. Handle edge cases in comments: (1) Remove spaces, dashes, parentheses: '+1 (555) 123-4567' -> '+15551234567', (2) Ensure leading + for international format, (3) Reject if too short (<10 digits after +) or too long (>15 digits). Export function. Add E164PhoneSchema import from './validation'.",
      "context": {
        "read_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/ARCHITECTURE_REPORT.md (section 13.4 Input Validation)"
        ],
        "edit_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/lib/phone-normalizer.ts"
        ]
      },
      "constraints": [
        "Use E164PhoneSchema from validation.ts for final validation (re-use schema)",
        "Strip regex: /[^+\\d]/g (keep only + and digits)",
        "Minimum 10 digits after country code (ITU-T E.164 max 15 digits)",
        "Maximum 15 digits after country code",
        "Must start with + after normalization",
        "Throw ZodError with detailed message for invalid format"
      ],
      "verification_steps": [
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'normalizePhoneNumber' src/lib/phone-normalizer.ts && grep -q 'E164PhoneSchema' src/lib/phone-normalizer.ts",
          "expected_output": "exit code 0"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q '/\\[^+\\\\d\\]/g' src/lib/phone-normalizer.ts",
          "expected_output": "exit code 0"
        }
      ]
    },
    {
      "id": "P1-002",
      "title": "Implement state management endpoints",
      "status": "pending",
      "priority": "P1",
      "dependencies": ["P0-003", "P0-004"],
      "description": "Implement /Users/jp/CodingProjects/DonClaudioBot/onboarding/src/routes/state.ts replacing placeholder. Import express, webhookAuth, getState, updateState, setStatus. Export router = Router(). Apply webhookAuth middleware to all routes. GET /onboarding/state/:phone handler: const state = await getState(req.params.phone); if (!state) return res.status(404).json({error: 'Not found'}); return res.json(state). POST /onboarding/update handler: const {status, name, email} = req.body; if (!status && !name && !email) return res.status(400).json({error: 'At least one field required'}); await updateState(req.body.phone, {status, name, email}); return res.json({success: true}). POST /onboarding/handover: await setStatus(req.body.phone, 'complete'); return res.json({status: 'handed_over', agentId: result.agent_id}).",
      "context": {
        "read_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/routes/state.ts"
        ],
        "edit_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/routes/state.ts"
        ]
      },
      "constraints": [
        "Use express.Router() for routing",
        "Apply webhookAuth middleware to all endpoints (same security as webhook)",
        "GET returns 404 if phone not found in database",
        "POST validates at least one of status, name, email is present (reject empty updates)",
        "handover endpoint must set status to 'complete' per state machine",
        "All routes use phone from body for POST, from params for GET (consistency)"
      ],
      "verification_steps": [
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q \"router.get('/onboarding/state/:phone'\" src/routes/state.ts && grep -q \"router.post('/onboarding/update'\" src/routes/state.ts",
          "expected_output": "exit code 0"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q \"/onboarding/handover\" src/routes/state.ts && grep -q 'setStatus' src/routes/state.ts",
          "expected_output": "exit code 0"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'webhookAuth' src/routes/state.ts",
          "expected_output": "exit code 0"
        }
      ]
    },
    {
      "id": "P1-003",
      "title": "Investigate and document onboarding trigger mechanism",
      "status": "pending",
      "priority": "P1",
      "dependencies": ["P0-008"],
      "description": "INVESTIGATION TASK: The architecture assumes 'command:new' triggers on new WhatsApp messages, but OpenClaw hooks fire on agent commands (/new, /reset), not incoming messages. This task investigates the correct trigger mechanism. Steps: (1) Search QMD for 'messages.upsert', 'inbox listener', 'channel events' to find incoming message handling, (2) Check if OpenClaw has a 'message:received' or 'dm:new' event type, (3) If no event exists, document alternative: Baileys WhatsApp library exposes 'messages.upsert' event that could call webhook directly, (4) Create /Users/jp/CodingProjects/DonClaudioBot/docs/ONBOARDING_TRIGGER.md documenting findings and recommended approach, (5) Include manual testing curl command for webhook while investigation continues. This unblocks P0 work - webhook can be called manually/externally until trigger is resolved.",
      "pre_investigation_findings": {
        "source": "Principal Engineer QMD review 2026-01-31",
        "key_finding": "OpenClaw hooks.md lists 'message:received' under 'Future Events' section with note 'Planned event types' - THIS IS NOT IMPLEMENTED YET",
        "current_hook_events": ["command:new", "command:reset", "command:stop", "agent:bootstrap", "gateway:startup"],
        "implication": "Cannot use OpenClaw hooks for incoming message trigger. Must find alternative.",
        "likely_alternatives": [
          "Baileys 'messages.upsert' event handler in WhatsApp channel code",
          "Custom middleware in OpenClaw gateway startup",
          "External WhatsApp webhook (if using WhatsApp Business API instead of Baileys)",
          "Polling approach checking for new unbound senders"
        ],
        "recommendation": "Focus investigation on Baileys integration point - search for 'messages.upsert' or 'sock.ev.on' in OpenClaw WhatsApp channel source"
      },
      "context": {
        "read_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/.openclaw-reference/hooks.md",
          "/Users/jp/CodingProjects/DonClaudioBot/.openclaw-reference/channels/whatsapp.md"
        ],
        "edit_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/docs/ONBOARDING_TRIGGER.md"
        ]
      },
      "constraints": [
        "This is a RESEARCH task, not implementation",
        "Must use QMD MCP server to search OpenClaw documentation",
        "Document ALL findings, even if inconclusive",
        "Include manual webhook test command: curl -X POST -H 'Authorization: Bearer $HOOK_TOKEN' -H 'Content-Type: application/json' -d '{\"phone\":\"+15551234567\"}' http://127.0.0.1:3000/webhook/onboarding",
        "If hook approach is viable, document exact event name and handler structure",
        "If hook approach is NOT viable, document alternative (Baileys event, custom gateway modification)",
        "IMPORTANT: Pre-investigation findings above confirm message:received is NOT implemented. Start from this baseline."
      ],
      "verification_steps": [
        {
          "command": "test -f /Users/jp/CodingProjects/DonClaudioBot/docs/ONBOARDING_TRIGGER.md",
          "expected_output": "exit code 0"
        },
        {
          "command": "grep -q 'curl.*webhook/onboarding' /Users/jp/CodingProjects/DonClaudioBot/docs/ONBOARDING_TRIGGER.md",
          "expected_output": "exit code 0"
        },
        {
          "command": "grep -qi 'messages.upsert\\|message:received\\|hook\\|trigger' /Users/jp/CodingProjects/DonClaudioBot/docs/ONBOARDING_TRIGGER.md",
          "expected_output": "exit code 0"
        }
      ]
    },
    {
      "id": "P1-004",
      "title": "Implement onboarding trigger (based on P1-003 findings)",
      "status": "pending",
      "priority": "P1",
      "dependencies": ["P0-008", "P1-003"],
      "description": "Implement the onboarding trigger based on P1-003 investigation findings. IF hooks are viable: Create ~/.openclaw/hooks/onboarding-trigger/ with HOOK.md and handler.ts per the original design. IF hooks are NOT viable: Implement alternative approach documented in P1-003 (likely a WhatsApp channel event listener or gateway modification). The implementation MUST: (1) Trigger when new/unknown user sends first WhatsApp message, (2) Call POST /webhook/onboarding with {phone: senderId}, (3) Include Authorization: Bearer $HOOK_TOKEN header, (4) Only trigger for WhatsApp DMs (not groups), (5) Be idempotent (webhook handles duplicate calls gracefully).",
      "context": {
        "read_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/docs/ONBOARDING_TRIGGER.md",
          "/Users/jp/CodingProjects/DonClaudioBot/.openclaw-reference/hooks.md"
        ],
        "edit_files": [
          "Depends on P1-003 findings - likely ~/.openclaw/hooks/onboarding-trigger/ OR custom event listener"
        ]
      },
      "constraints": [
        "MUST wait for P1-003 to complete - do not assume hook approach works",
        "Use 127.0.0.1 not localhost (avoid IPv6 lookup issues)",
        "Pass HOOK_TOKEN via Authorization: Bearer header",
        "Only trigger for WhatsApp DM messages (check channel and peer type)",
        "Log trigger attempts for debugging: '[onboarding-trigger] New message from: ' + phone"
      ],
      "verification_steps": [
        {
          "command": "echo 'Verification depends on P1-003 findings - check ONBOARDING_TRIGGER.md for implementation path'",
          "expected_output": "exit code 0"
        }
      ]
    },
    {
      "id": "P1-005",
      "title": "Implement OAuth refresh failure handling",
      "status": "pending",
      "priority": "P1",
      "dependencies": ["P0-003"],
      "description": "Create /Users/jp/CodingProjects/DonClaudioBot/onboarding/src/services/oauth-monitor.ts. Implement functions: (1) checkOAuthHealth(agentId: string): Promise<{healthy: boolean, error?: string}> - checks if ~/.openclaw/agents/{agentId}/agent/.gog/tokens.json exists via fs.access(), reads file, checks expiry field > Date.now(), returns {healthy: false, error: 'Token expired'} if >90 days old, (2) markOAuthFailed(phone: string, error: string): Promise<void> - calls updateState(phone, {oauth_error: error, status: 'oauth_failed'}), (3) cleanupExpiredTokens(): Promise<string[]> - lists all agents in ~/.openclaw/agents/, checks each for expired tokens (>90 days), returns array of expired agent IDs, logs '[oauth-monitor] Found expired tokens for agent: {id}'. Export all functions.",
      "context": {
        "read_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/ARCHITECTURE_REPORT.md (section 13 Security Architecture)"
        ],
        "edit_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/services/oauth-monitor.ts"
        ]
      },
      "constraints": [
        "Token path: ~/.openclaw/agents/{agentId}/agent/.gog/tokens.json",
        "90-day expiration check based on file mtime (fs.stat().mtime) or tokens.json expiry field",
        "Log OAuth failures with '[oauth-failed]' prefix for filtering",
        "Do NOT delete tokens automatically (only log and mark status - let user re-auth)",
        "Use fs.promises API for async file operations",
        "Import updateState from state-manager.ts for database updates"
      ],
      "verification_steps": [
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'checkOAuthHealth' src/services/oauth-monitor.ts && grep -q 'markOAuthFailed' src/services/oauth-monitor.ts",
          "expected_output": "exit code 0"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q '.gog/tokens.json' src/services/oauth-monitor.ts",
          "expected_output": "exit code 0"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'oauth-failed' src/services/oauth-monitor.ts",
          "expected_output": "exit code 0"
        }
      ]
    },
    {
      "id": "P1-006",
      "title": "Add state reconciliation job",
      "status": "pending",
      "priority": "P1",
      "dependencies": ["P0-003", "P0-005", "P1-005"],
      "description": "Create /Users/jp/CodingProjects/DonClaudioBot/onboarding/src/services/reconciliation.ts. Implement reconcileStates(): Promise<ReconciliationReport> function that: (1) Reads all agents from openclaw.json agents.list, (2) Reads all records from onboarding_states table, (3) Finds orphanedAgents: agents in config but not in DB, (4) Finds orphanedDbRecords: DB records with status != 'cancelled' but agent not in config, (5) Finds staleStates: records with updated_at < 24h ago and status in ['new', 'pending_welcome', 'collecting_info'], (6) Returns ReconciliationReport interface {orphanedAgents: string[], orphanedDbRecords: string[], invalidBindings: string[], staleStates: string[]}. Implement cleanupOrphans(report) that: deletes orphaned agents via 'openclaw agents remove', marks orphaned DB records as 'cancelled'. Export functions. Run via cron hourly.",
      "context": {
        "read_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/ARCHITECTURE_REPORT.md (section 12.5 State Reconciliation)"
        ],
        "edit_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/services/reconciliation.ts"
        ]
      },
      "constraints": [
        "Read config via readConfig() from config-writer.ts",
        "Use execAsync for 'openclaw agents remove' CLI command",
        "Mark orphaned DB records with status='cancelled' (don't delete - audit trail)",
        "Stale threshold: 24 hours for incomplete onboarding states",
        "Log all reconciliation actions with '[reconciliation]' prefix",
        "Define ReconciliationReport as exported interface",
        "Import better-sqlite3 for direct DB queries (or use state-manager functions)"
      ],
      "verification_steps": [
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'reconcileStates' src/services/reconciliation.ts && grep -q 'ReconciliationReport' src/services/reconciliation.ts",
          "expected_output": "exit code 0"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'orphanedAgents' src/services/reconciliation.ts && grep -q 'staleStates' src/services/reconciliation.ts",
          "expected_output": "exit code 0"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'cleanupOrphans' src/services/reconciliation.ts",
          "expected_output": "exit code 0"
        }
      ]
    },
    {
      "id": "P2-001",
      "title": "Define sandbox resource limits",
      "status": "pending",
      "priority": "P2",
      "dependencies": ["P0-006"],
      "description": "Update /Users/jp/CodingProjects/DonClaudioBot/onboarding/src/services/agent-creator.ts sandbox config to add Docker resource limits. In agentConfig.sandbox.docker, add: (1) memory: '512m' (max 512MB RAM per sandbox), (2) cpus: '0.5' (max 50% of one CPU core), (3) pids_limit: 100 (max 100 processes - prevent fork bombs). Keep existing image, network, env, binds, setupCommand. Document limits in comment above config: '// Sandbox resource limits: 512MB RAM, 0.5 CPU, 100 PIDs - sufficient for Node.js + gog CLI, prevents host exhaustion'. These limits prevent sandbox from consuming host resources while allowing gog CLI and basic OAuth operations.",
      "context": {
        "read_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/services/agent-creator.ts"
        ],
        "edit_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/services/agent-creator.ts"
        ]
      },
      "constraints": [
        "Memory limit: 512m (sufficient for Node.js runtime + gog CLI + basic operations)",
        "CPU limit: 0.5 (half a CPU core - allows multiple agents on same host)",
        "PIDs limit: 100 (prevent fork bombs inside sandbox)",
        "Keep network: 'bridge' for external API access (Google OAuth requires)",
        "Do NOT set privileged: true (security risk per DP7)",
        "Do NOT set cap_add (no additional capabilities needed)"
      ],
      "verification_steps": [
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q \"memory: '512m'\" src/services/agent-creator.ts && grep -q \"cpus: '0.5'\" src/services/agent-creator.ts",
          "expected_output": "exit code 0"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'pids_limit' src/services/agent-creator.ts",
          "expected_output": "exit code 0"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'Sandbox resource limits' src/services/agent-creator.ts",
          "expected_output": "exit code 0"
        }
      ]
    },
    {
      "id": "P2-002",
      "title": "Add integration tests for onboarding flow",
      "status": "pending",
      "priority": "P2",
      "dependencies": ["P0-008"],
      "description": "Create /Users/jp/CodingProjects/DonClaudioBot/onboarding/src/__tests__/onboarding.flow.test.ts using vitest. Import {describe, it, expect, vi, beforeEach} from 'vitest', {createAgent, getState} from '../services/agent-creator', request from 'supertest'. Mock services: vi.mock('../services/agent-creator'), vi.mock('../services/state-manager'). Test suite: (1) testWebhookCreatesAgent - mocks createAgent.mockResolvedValue('user_abc123'), mocks getState.mockResolvedValue(null), calls POST /webhook/onboarding with {phone: '+15551234567'}, expects 201 with {status: 'created', agentId: 'user_abc123'}, (2) testIdempotentCall - mocks getState.mockResolvedValue({agent_id: 'user_existing', status: 'active'}), calls webhook twice, expects 200 second time with same agentId, (3) testInvalidPhone - sends {phone: 'invalid'}, expects 400 with error message, (4) testMissingAuth - sends without Authorization header, expects 401. Run with 'npm test'.",
      "context": {
        "read_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/routes/webhook.ts"
        ],
        "edit_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/onboarding/src/__tests__/onboarding.flow.test.ts"
        ]
      },
      "constraints": [
        "Use vitest for testing framework (not jest - lighter weight)",
        "Use supertest for HTTP assertion testing",
        "Mock agent-creator and state-manager with vi.mock() (auto-mocked)",
        "Test all status codes: 200 (existing), 201 (created), 400 (validation), 401 (auth)",
        "Verify createAgent is called exactly once for new phone (expect(createAgent).toHaveBeenCalledTimes(1))",
        "Verify getState is called on second request (idempotent check)",
        "Clear mocks with vi.clearAllMocks() in beforeEach"
      ],
      "verification_steps": [
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q \"describe('onboarding flow'\" src/__tests__/onboarding.flow.test.ts && grep -q 'vitest' package.json",
          "expected_output": "exit code 0"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'vi.mock' src/__tests__/onboarding.flow.test.ts && grep -q 'supertest' src/__tests__/onboarding.flow.test.ts",
          "expected_output": "exit code 0"
        },
        {
          "command": "cd /Users/jp/CodingProjects/DonClaudioBot/onboarding && grep -q 'beforeEach' src/__tests__/onboarding.flow.test.ts",
          "expected_output": "exit code 0"
        }
      ]
    },
    {
      "id": "P2-003",
      "title": "Create Docker sandbox image with gog CLI",
      "status": "pending",
      "priority": "P2",
      "dependencies": [],
      "description": "Create /Users/jp/CodingProjects/DonClaudioBot/config/sandbox/Dockerfile.sandbox for building sandbox image with gog CLI pre-installed (DP4 resolution). FROM node:22-bookworm-slim. RUN apt-get update && apt-get install -y curl git jq. RUN curl -fsSL https://raw.githubusercontent.com/example/gog/main/install.sh | sh. WORKDIR /home/node. ENV PATH=/home/node/.local/bin:$PATH. COPY --chown=node:node config/agents/dedicated/ /home/node/workspace/. ENTRYPOINT [\"node\"]. Build with: docker build -f config/sandbox/Dockerfile.sandbox -t openclaw-sandbox:bookworm-slim config/sandbox/. This image includes gog CLI for Google OAuth operations inside sandboxed agents.",
      "context": {
        "read_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/ARCHITECTURE_REPORT.md (section 8.4 Docker Image)"
        ],
        "edit_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/config/sandbox/Dockerfile.sandbox"
        ]
      },
      "constraints": [
        "Base image: node:22-bookworm-slim (matches host runtime)",
        "Install curl, git, jq for gog CLI installation and operations",
        "Install gog CLI via official install script (placeholder URL - replace with actual)",
        "Set PATH to include ~/.local/bin where gog installs",
        "Use non-root node user for security",
        "WORKDIR should be /home/node (matches OpenClaw sandbox defaults)",
        "Tag final image as openclaw-sandbox:bookworm-slim (matches agent-creator config)"
      ],
      "verification_steps": [
        {
          "command": "grep -q 'FROM node:22-bookworm-slim' /Users/jp/CodingProjects/DonClaudioBot/config/sandbox/Dockerfile.sandbox && grep -q 'gog' /Users/jp/CodingProjects/DonClaudioBot/config/sandbox/Dockerfile.sandbox",
          "expected_output": "exit code 0"
        },
        {
          "command": "grep -q 'WORKDIR /home/node' /Users/jp/CodingProjects/DonClaudioBot/config/sandbox/Dockerfile.sandbox",
          "expected_output": "exit code 0"
        }
      ]
    },
    {
      "id": "P2-004",
      "title": "Create sandbox build script",
      "status": "pending",
      "priority": "P2",
      "dependencies": ["P2-003"],
      "description": "Create /Users/jp/CodingProjects/DonClaudioBot/scripts/build-sandbox.sh bash script to build sandbox image. #!/bin/bash. set -e. IMAGE_NAME='openclaw-sandbox:bookworm-slim'. DOCKERFILE='config/sandbox/Dockerfile.sandbox'. echo 'Building sandbox image: $IMAGE_NAME...'. docker build -f \"$DOCKERFILE\" -t \"$IMAGE_NAME\" . echo 'Sandbox image built successfully: $IMAGE_NAME'. echo 'To verify: docker run --rm $IMAGE_NAME gog --version'. Make executable with chmod +x. This script builds the sandbox Docker image with gog CLI pre-installed for use in agent sandboxes.",
      "context": {
        "read_files": [],
        "edit_files": [
          "/Users/jp/CodingProjects/DonClaudioBot/scripts/build-sandbox.sh"
        ]
      },
      "constraints": [
        "Use 'set -e' to exit on any error (fail-fast)",
        "Image name must match agent-creator.ts config: openclaw-sandbox:bookworm-slim",
        "Dockerfile path relative to project root: config/sandbox/Dockerfile.sandbox",
        "Build context should be project root (.) for COPY commands to work",
        "Log progress with echo statements",
        "Include verification command in output message (gog --version)"
      ],
      "verification_steps": [
        {
          "command": "grep -q 'set -e' /Users/jp/CodingProjects/DonClaudioBot/scripts/build-sandbox.sh && grep -q 'docker build' /Users/jp/CodingProjects/DonClaudioBot/scripts/build-sandbox.sh",
          "expected_output": "exit code 0"
        },
        {
          "command": "grep -q 'openclaw-sandbox:bookworm-slim' /Users/jp/CodingProjects/DonClaudioBot/scripts/build-sandbox.sh",
          "expected_output": "exit code 0"
        },
        {
          "command": "test -x /Users/jp/CodingProjects/DonClaudioBot/scripts/build-sandbox.sh",
          "expected_output": "exit code 0"
        }
      ]
    }
  ]
}
